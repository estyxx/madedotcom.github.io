name: Github Pages Deploy
on:
  push:
    branches:
      - blog-react

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2.3.1

      - name: Cache
        uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}

      - uses: jwalton/gh-find-current-pr@v1
        id: finder

      - name: Generate slug
        id: generate_slug
        run: echo "##[set-output name=slug;]$(echo ${GITHUB_HEAD_REF#refs/heads/} | sed -r 's/[~\^]+//g' | sed -r 's/[^a-zA-Z0-9]+/-/g' | sed -r 's/^-+\|-+$//g' | tr A-Z a-z)"

      - name: Install and Build ğŸ”§
        run: |
          yarn install
          yarn build

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.6
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: .next # The folder the action should deploy.
          target-folder: ${{ steps.generate_slug.outputs.slug }}

      - name: Publish env
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.finder.outputs.pr }}
          header: Preview environment
          message: |
            ## Preview environment
            https://io.made.com/madedotcom/${{ steps.generate_slug.outputs.slug }}/
