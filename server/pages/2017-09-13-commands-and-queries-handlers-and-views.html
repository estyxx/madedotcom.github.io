<!DOCTYPE html><html><head><link rel="icon" href="https://media.made.com/mws-assets/images/favicon.1.ico"/><link media="screen,handheld" type="text/css" rel="stylesheet" href="https://media.made.com/mws-assets/fontBase_b900f8d534cc10f95604.css"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Commands and queries handlers and views</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-f8fe1f0eb2299c5d.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-208998328ec77b24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6cbe5accd1ec8e19.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-85c1567484db8bdb.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_buildManifest.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_ssgManifest.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_middlewareManifest.js" defer=""></script></head><body><script>(function setScript(initialValue) {
  var mql = window.matchMedia("(prefers-color-scheme: dark)");
  var systemPreference = mql.matches ? "dark" : "light";
  var persistedPreference;

  try {
    persistedPreference = localStorage.getItem("chakra-ui-color-mode");
  } catch (error) {
    console.log("Chakra UI: localStorage is not available. Color mode persistence might not work as expected");
  }

  var isInStorage = typeof persistedPreference === "string";
  var colorMode;

  if (isInStorage) {
    colorMode = persistedPreference;
  } else {
    colorMode = initialValue === "system" ? systemPreference : initialValue;
  }

  if (colorMode) {
    var root = document.documentElement;
    root.style.setProperty("--chakra-ui-color-mode", colorMode);
  }
})('light')</script><div id="__next"><style data-emotion="css-global 1vs9c57">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-5:#fff2f0;--chakra-colors-red-10:#ffdfdd;--chakra-colors-red-50:#F15856;--chakra-colors-red-80:#d03740;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-5:#e4fbe5;--chakra-colors-green-10:#ccf5ce;--chakra-colors-green-50:#30a75b;--chakra-colors-green-80:#008248;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-made-5:#fafafa;--chakra-colors-made-10:#f5f6f4;--chakra-colors-made-20:#eef0ed;--chakra-colors-made-30:#e1e3de;--chakra-colors-made-40:#bdbfbb;--chakra-colors-made-50:#9fa19d;--chakra-colors-made-60:#767874;--chakra-colors-made-70:#626360;--chakra-colors-made-80:#434442;--chakra-colors-made-90:#222321;--chakra-colors-made-black:#131413;--chakra-colors-made-baige:#d9c3b8;--chakra-colors-made-green:#c0d0cf;--chakra-colors-made-grey:#d7d3d0;--chakra-colors-made-blue:#353F7D;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:FS Neruda;--chakra-fonts-body:FS Meridian Regular,sans-serif;--chakra-fonts-mono:FS Hack;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1syi0wy">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 1baqkrf">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-gray-800);background:var(--chakra-colors-white);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}</style><style data-emotion="css mfxtb">.css-mfxtb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;box-shadow:var(--chakra-shadows-base);width:100%;margin-bottom:var(--chakra-space-8);padding:var(--chakra-space-8);}</style><header class="css-mfxtb"><style data-emotion="css 18ci58h">.css-18ci58h{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;max-width:var(--chakra-sizes-8xl);width:100%;margin:auto;}</style><div class="css-18ci58h"><div class="css-0"><a href="/"><img alt="Logo" src="https://media.made.com/mws-assets/images/MadeLogo.2.svg" class="chakra-image css-0" aria-label="Logo"/></a></div><style data-emotion="css 1wsmmqi">@media screen and (min-width: 30em){.css-1wsmmqi{display:block;}}@media screen and (min-width: 48em){.css-1wsmmqi{display:none;}}</style><div class="css-1wsmmqi"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div><style data-emotion="css 3txhs">.css-3txhs{display:none;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;margin-left:auto;}@media screen and (min-width: 48em){.css-3txhs{display:block;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;}}</style><div class="css-3txhs"><style data-emotion="css 1lpw2d">.css-1lpw2d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:var(--chakra-space-8);-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}@media screen and (min-width: 30em){.css-1lpw2d{-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 48em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 62em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}</style><div class="chakra-stack css-1lpw2d"><style data-emotion="css f4h6uy">.css-f4h6uy{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;}.css-f4h6uy:hover,.css-f4h6uy[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-f4h6uy:focus,.css-f4h6uy[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-f4h6uy" href="/"><style data-emotion="css 13o7eu2">.css-13o7eu2{display:block;}</style><p class="chakra-text css-13o7eu2">Home</p></a><a class="chakra-link css-f4h6uy" href="https://www.made.com/careers"><p class="chakra-text css-13o7eu2">Careers</p></a></div></div></div></header><style data-emotion="css 1gg6tci">.css-1gg6tci{width:100%;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;max-width:var(--chakra-sizes-2xl);-webkit-padding-start:1rem;padding-inline-start:1rem;-webkit-padding-end:1rem;padding-inline-end:1rem;}</style><div class="chakra-container css-1gg6tci"><style data-emotion="css 1xr7jem">.css-1xr7jem{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-5xl);line-height:1;margin-bottom:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-1xr7jem{font-size:var(--chakra-fontSizes-6xl);}}</style><h1 class="chakra-heading css-1xr7jem">Commands and queries handlers and views</h1><style data-emotion="css 1iv087f">.css-1iv087f{margin-bottom:var(--chakra-space-2);font-weight:var(--chakra-fontWeights-bold);}</style><p class="chakra-text css-1iv087f">by <!-- -->Bob</p><style data-emotion="css b64cj9">.css-b64cj9{margin-bottom:var(--chakra-space-4);color:var(--chakra-colors-made-50);}</style><p class="chakra-text css-b64cj9">Wed Sep 13 2017</p><style data-emotion="css rszk63">.css-rszk63{margin-bottom:var(--chakra-space-4);}</style><p class="chakra-text css-rszk63">In the first and second parts of this series I introduced the Command-Handler
<!-- -->[https://io.made.com/blog/introducing-command-handler/]<!-- --> and Unit of Work and Repository
<!-- -->[https://io.made.com/blog/repository-and-unit-of-work-pattern-in-python/]<!-- --> patterns. I
was intending to write about Message Buses, and some more stuff about domain modelling,
but I need to quickly skim over this first.</p><p class="chakra-text css-rszk63">If you&#x27;ve just started reading the Message Buses piece, and you&#x27;re here to learn about
Application-Controlled Identifiers, you&#x27;ll find those at the end of post, after a bunch
of stuff about ORMs, CQRS, and some casual trolling of junior programmers.</p><p class="chakra-text css-rszk63">What is CQS ? The Command Query Separation
<!-- -->[https://martinfowler.com/bliki/CommandQuerySeparation.html]<!-- --> principle was first
described by Bertrand Meyer in the late Eighties. Per wikipedia
<!-- -->[https://en.wikipedia.org/wiki/Command%E2%80%93query_separation]<!-- -->, the principle states:</p><p class="chakra-text css-rszk63">every method should either be a command that performs an action, or a query that returns
data to the caller, but not both. In other words, &quot;Asking a question should not change
the answer&quot;. More formally, methods should return a value only if they are referentially
transparent and hence possess no side effects.</p><p class="chakra-text css-rszk63">Referential transparency is an important concept from functional programming. Briefly, a
function is referentially transparent if you could replace it with a static value.</p><p class="chakra-text css-rszk63">class LightSwitch:</p><pre><style data-emotion="css 77j1of">.css-77j1of{background:var(--chakra-colors-orange-50);border-radius:10px;margin-bottom:var(--chakra-space-10);font-size:var(--chakra-fontSizes-sm);box-shadow:var(--chakra-shadows-lg);}</style><div class="chakra-wrap css-77j1of"><style data-emotion="css umyqv7">.css-umyqv7{--chakra-wrap-spacing:0.5rem;--wrap-spacing:calc(var(--chakra-wrap-spacing) / 2);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;list-style-type:none;padding:0px;margin:calc(var(--wrap-spacing) * -1);}.css-umyqv7>*:not(style){margin:var(--wrap-spacing);}</style><ul class="chakra-wrap__list css-umyqv7"><style data-emotion="css r4358i">.css-r4358i{padding:var(--chakra-space-5);}</style><div class="css-r4358i">def toggle_light(self):
    self.light_is_on = not self.light_is_on
    return self.light_is_on

@property
def is_on(self):
    return self.light_is_on
</div></ul></div></pre><p class="chakra-text css-rszk63">In this class, the is_on method is referentially transparent - I can replace it with the
value True or False without any loss of functionality, but the method toggle_light is
side-effectual: replacing its calls with a static value would break the contracts of the
system. To comply with the Command-Query separation principle, we should not return a
value from our toggle_light method.</p><p class="chakra-text css-rszk63">In some languages we would say that the is_on method is &quot;pure&quot;. The advantage of
splitting our functions into those that have side effects and those that are pure is
that the code becomes easier to reason about. Haskell loves pure functions, and uses
this reasonability to do strange things, like re-ordering your code for you at
compilation time to make it more efficient. For those of us who work in more prosaic
languages, if commands and queries are clearly distinguished, then I can read through a
code base and understand all the ways in which state can change. This is a huge win for
debugging because there is nothing worse than troubleshooting a system when you can&#x27;t
work out which code-paths are changing your data.</p><p class="chakra-text css-rszk63">How do we get data out of a Command-Handler architecture? When we&#x27;re working in a
Command-Handler system we obviously use Commands and Handlers to perform state changes,
but what should we do when we want to get data back out of our model? What is the
equivalent port for queries?</p><p class="chakra-text css-rszk63">The answer is &quot;it depends&quot;. The lowest-cost option is just to re-use your repositories
in your UI entrypoints.</p><p class="chakra-text css-rszk63">@app.route(&quot;/issues&quot;) def list_issues(): with unit_of_work_manager.start() as
unit_of_work: open_issues = unit_of_work.issues.find_by_status(&#x27;open&#x27;) return
json.dumps(open_issues)</p><p class="chakra-text css-rszk63">This is totally fine unless you have complex formatting, or multiple entrypoints to your
system. The problem with using your repositories directly in this way is that it&#x27;s a
slippery slope. Sooner or later you&#x27;re going to have a tight deadline, and a simple
requirement, and the temptation is to skip all the command/handler nonsense and do it
directly in the web api.</p><p class="chakra-text css-rszk63">@app.route(&#x27;/issues/&lt;issue_id&gt;&#x27;, methods=<!-- -->[&#x27;DELETE&#x27;]<!-- -->) def delete_issue(issue_id): with
unit_of_work_manager.start() as uow: issue = uow.issues<!-- -->[issue_id]<!-- --> issue.delete()
uow.commit()</p><p class="chakra-text css-rszk63">Super convenient, but then you need to add some error handling and some logging and an
email notification.</p><p class="chakra-text css-rszk63">@app.route(&#x27;/issues/&lt;issue_id&gt;&#x27;, methods=<!-- -->[&#x27;DELETE&#x27;]<!-- -->) def delete_issue(issue_id):
logging.info(&quot;Handling DELETE of issue &quot;+str(issue_id))</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">with unit_of_work_manager.start() as uow:
   issue = uow.issues[issue_id]

   if issue is None:
       logging.warn(&quot;Issue not found&quot;)
       flask.abort(404)
   if issue.status != &#x27;deleted&#x27;:
      issue.delete()
      uow.commit()
      try:
         smtp.send_notification(Issue.Deleted, issue_id)
      except:
         logging.error(
            &quot;Failed to send email notification for deleted issue &quot;
             + str(issue_id), exn_info=True)
   else:
      logging.info(&quot;Issue already deleted. NOOP&quot;)
return &quot;Deleted!&quot;, 202
</div></ul></div></pre><p class="chakra-text css-rszk63">Aaaaand, we&#x27;re back to where we started: business logic mixed with glue code, and the
whole mess slowly congealing in our web controllers. Of course, the slippery slope
argument isn&#x27;t a good reason not to do something, so if your queries are very simple,
and you can avoid the temptation to do updates from your controllers, then you might as
well go ahead and read from repositories, it&#x27;s all good, you have my blessing. If you
want to avoid this, because your reads are complex, or because you&#x27;re trying to stay
pure, then instead we could define our views explicitly.</p><p class="chakra-text css-rszk63">class OpenIssuesList:</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">def __init__(self, sessionmaker):
    self.sessionmaker = sessionmaker

def fetch(self):
    with self.sessionmaker() as session:
        result = session.execute(
            &#x27;SELECT reporter_name, timestamp, title
             FROM issues WHERE state=&quot;open&quot;&#x27;)
        return [dict(r) for r in result.fetchall()]
</div></ul></div></pre><p class="chakra-text css-rszk63">@api.route(&#x27;/issues/&#x27;) def list_issues(): view_builder = OpenIssuesList(session_maker)
return jsonify(view_builder.fetch())</p><p class="chakra-text css-rszk63">This is my favourite part of teaching ports and adapters to junior programmers, because
the conversation inevitably goes like this:</p><p class="chakra-text css-rszk63">smooth-faced youngling: Wow, um... are you - are we just going to hardcode that sql in
there? Just ... run it on the database?</p><p class="chakra-text css-rszk63">grizzled old architect: Yeah, I think so. Do The Simplest Thing That Could Possibly
Work, right? YOLO, and so forth.</p><p class="chakra-text css-rszk63">sfy: Oh, okay. Um... but what about the unit of work and the domain model and the
service layer and the hexagonal stuff? Didn&#x27;t you say that &quot;Data access ought to be
performed against the aggregate root for the use case, so that we maintain tight control
of transactional boundaries&quot;?</p><p class="chakra-text css-rszk63">goa: Ehhhh... I don&#x27;t feel like doing that right now, I think I&#x27;m getting hungry.</p><p class="chakra-text css-rszk63">sfy: Right, right ... but what if your database schema changes?</p><p class="chakra-text css-rszk63">goa: I guess I&#x27;ll just come back and change that one line of SQL. My acceptance tests
will fail if I forget, so I can&#x27;t get the code through CI.</p><p class="chakra-text css-rszk63">sfy: But why don&#x27;t we use the Issue model we wrote? It seems weird to just ignore it and
return this dict... and you said &quot;Avoid taking a dependency directly on frameworks. Work
against an abstraction so that if your dependency changes, that doesn&#x27;t force change to
ripple through your domain&quot;. You know we can&#x27;t unit test this, right?</p><p class="chakra-text css-rszk63">goa: Ha! What are you, some kind of architecture astronaut? Domain models! Who needs
&#x27;em.</p><p class="chakra-text css-rszk63">Why have a separate read-model? In my experience, there are two ways that teams go wrong
when using ORMs. The most common mistake is not paying enough attention to the
boundaries of their use cases. This leads to the application making far too many calls
to the database because people write code like this:</p><style data-emotion="css 1i61012">.css-1i61012{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-6xl);line-height:1;}@media screen and (min-width: 48em){.css-1i61012{font-size:var(--chakra-fontSizes-7xl);}}</style><h1 class="chakra-heading css-1i61012">Find all users who are assigned this task</h1><h1 class="chakra-heading css-1i61012">[<!-- -->[and]<!-- -->] notify them and their line manager</h1><h1 class="chakra-heading css-1i61012">then move the task to their in-queue</h1><p class="chakra-text css-rszk63">notification = task.as_notification() for assignee in task.assignees:
assignee.manager.notifications.add(notification)
assignee.notifications.add(notification) assignee.queues.inbox.add(task)</p><p class="chakra-text css-rszk63">ORMs make it very easy to &quot;dot&quot; through the object model this way, and pretend that we
have our data in memory, but this quickly leads to performance issues when the ORM
generates hundreds of select statements in response. Then they get all angry about
performance and write long blog posts about how ORM sucks and is an anti-pattern and
only n00bs like it. This is akin to blaming OO for your domain logic ending up in the
controller.</p><p class="chakra-text css-rszk63">The second mistake that teams make is using an ORM when they don&#x27;t need to. Why do we
use an ORM in the first place? I think that a good ORM gives us two things:</p><ol><li>A unit of work pattern which can be used to control our consistency boundaries.</li><li>A data mapper pattern that lets us map a complex object graph to relational tables,
without writing tons of boring glue code.</li></ol><p class="chakra-text css-rszk63">Taken together, these patterns help us to write rich domain models by removing all the
database cruft so we can focus on our use-cases. This allows us to model complex
business processes in an internally consistent way. When I&#x27;m writing a GET method,
though, I don&#x27;t care about any of that. My view doesn&#x27;t need any business logic, because
it doesn&#x27;t change any state. For 99.5% of use cases, it doesn&#x27;t even matter if my data
are fetched inside a transaction. If I perform a dirty read when listing the issues, one
of three things might happen:</p><ol><li>I might see changes that aren&#x27;t yet committed - maybe an Issue that has just been
deleted will still show up in the list.</li><li>I might not see changes that have been committed - an Issue could be missing from
the list, or a title might be 10ms out of date.</li><li>I might see duplicates of my data - an Issue could appear twice in the list.</li></ol><p class="chakra-text css-rszk63">In many systems all these occurrences are unlikely, and will be resolved by a page
refresh or following a link to view more data. To be clear, I&#x27;m not recommending that
you turn off transactions for your SELECT statements, just noting that transactional
consistency is usually only a real requirement when we are changing state. When viewing
state, we can almost always accept a weaker consistency model.</p><p class="chakra-text css-rszk63">CQRS is CQS at a system-level CQRS stands for Command-Query Responsibility Segregation,
and it&#x27;s an architectural pattern that was popularised by Greg Young. A lot of people
misunderstand CQRS, and think you need to use separate databases and crazy asynchronous
processors to make it work. You can do these things, and I want to write more about that
later, but CQRS just means that we separate the Write Model - what we normally think of
as the domain model - and the Read Model - a lightweight, simple model for showing on
the UI, or answering questions about the domain state.</p><p class="chakra-text css-rszk63">When I&#x27;m serving a write request (a command), my job is to protect the invariants of the
system, and model the business process as it appears in the minds of our domain experts.
I take the collective understanding of our business analysts, and turn it into a state
machine that makes useful work happen. When I&#x27;m serving a read request (a query), my job
is to get the data out of the database as fast as possible and onto a screen so the user
can view it. Anything that gets in the way of my doing that is bloat.</p><p class="chakra-text css-rszk63">This isn&#x27;t a new idea, or particularly controversial. We&#x27;ve all tried writing reports
against an ORM, or complex hierarchical listing pages, and hit performance barriers.
When we get to that point, the only thing we can do - short of rewriting the whole
model, or abandoning our use of an ORM - is to rewrite our queries in raw SQL. Once upon
a time I&#x27;d feel bad for doing this, as though I were cheating, but nowadays I just
recognise that the requirements for my queries are fundamentally different than the
requirements for my commands.</p><p class="chakra-text css-rszk63">For the write-side of the system, use an ORM, for the read side, use whatever is a)
fast, and b) convenient.</p><p class="chakra-text css-rszk63">Application Controlled Identifiers At this point, a non-junior programmer will say</p><p class="chakra-text css-rszk63">Okay, Mr Smarty-pants Architect, if our commands can&#x27;t return any values, and our domain
models don&#x27;t know anything about the database, then how do I get an ID back from my save
method? Let&#x27;s say I create an API for creating new issues, and when I have POSTed the
new issue, I want to redirect the user to an endpoint where they can GET their new
Issue. How can I get the id back?</p><p class="chakra-text css-rszk63">The way I would recommend you handle this is simple - instead of letting your database
choose ids for you, just choose them yourself.</p><p class="chakra-text css-rszk63">@api.route(&#x27;/issues&#x27;, methods=<!-- -->[&#x27;POST&#x27;]<!-- -->) def report_issue(self): # uuids make great
domain-controlled identifiers, because # they can be shared amongst several systems and
are easy # to generate. issue_id = uuid.uuid4()</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">cmd = ReportIssueCommand(issue_id, **request.get_json())
handler.handle(cmd)
return &quot;&quot;, 201, { &#x27;Location&#x27;: &#x27;/issues/&#x27; + str(issue_id) }
</div></ul></div></pre><p class="chakra-text css-rszk63">There&#x27;s a few ways to do this, the most common is just to use a UUID, but you can also
implement something like hi-lo <!-- -->[https://pypi.python.org/pypi/sqlalchemy-hilo/0.1.2]<!-- -->. In
the new code sample
<!-- -->[https://github.com/bobthemighty/blog-code-samples/tree/master/ports-and-adapters/03]<!-- --> ,
I&#x27;ve implemented three flask endpoints, one to create a new issue, one to list all
issues, and one to view a single issue. I&#x27;m using UUIDs as my identifiers, but I&#x27;m still
using an integer primary key on the issues table, because using a GUID in a clustered
index leads to table fragmentation and sadness
<!-- -->[http://sqlmag.com/database-performance-tuning/clustered-indexes-based-upon-guids]<!-- --> .</p><p class="chakra-text css-rszk63">Okay, quick spot-check - how are we shaping up against our original Ports and Adapters
diagram? How do the concepts map?</p><p class="chakra-text css-rszk63">Pretty well! Our domain is pure and doesn&#x27;t know anything about infrastructure or IO. We
have a command and a handler that orchestrate a use-case, and we can drive our
application from tests or Flask. Most importantly, the layers on the outside depend on
the layers toward the centre.</p><p class="chakra-text css-rszk63">Next time I&#x27;ll get back to talking about message buses.</p></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var l=Object.defineProperty,p=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;var h=(e,t,a)=\u003et in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,o=(e,t)=\u003e{for(var a in t||(t={}))i.call(t,a)\u0026\u0026h(e,a,t[a]);if(n)for(var a of n(t))r.call(t,a)\u0026\u0026h(e,a,t[a]);return e},d=(e,t)=\u003ep(e,m(t));var u=(e,t)=\u003e{var a={};for(var s in e)i.call(e,s)\u0026\u0026t.indexOf(s)\u003c0\u0026\u0026(a[s]=e[s]);if(e!=null\u0026\u0026n)for(var s of n(e))t.indexOf(s)\u003c0\u0026\u0026r.call(e,s)\u0026\u0026(a[s]=e[s]);return a};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(a){var s=a,{components:e}=s,t=u(s,[\"components\"]);return mdx(MDXLayout,d(o(o({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`In the first and second parts of this series I introduced the Command-Handler\n`,\"[https://io.made.com/blog/introducing-command-handler/]\",` and Unit of Work and Repository\n`,\"[https://io.made.com/blog/repository-and-unit-of-work-pattern-in-python/]\",` patterns. I\nwas intending to write about Message Buses, and some more stuff about domain modelling,\nbut I need to quickly skim over this first.`),mdx(\"p\",null,`If you've just started reading the Message Buses piece, and you're here to learn about\nApplication-Controlled Identifiers, you'll find those at the end of post, after a bunch\nof stuff about ORMs, CQRS, and some casual trolling of junior programmers.`),mdx(\"p\",null,`What is CQS ? The Command Query Separation\n`,\"[https://martinfowler.com/bliki/CommandQuerySeparation.html]\",` principle was first\ndescribed by Bertrand Meyer in the late Eighties. Per wikipedia\n`,\"[https://en.wikipedia.org/wiki/Command%E2%80%93query_separation]\",\", the principle states:\"),mdx(\"p\",null,`every method should either be a command that performs an action, or a query that returns\ndata to the caller, but not both. In other words, \"Asking a question should not change\nthe answer\". More formally, methods should return a value only if they are referentially\ntransparent and hence possess no side effects.`),mdx(\"p\",null,`Referential transparency is an important concept from functional programming. Briefly, a\nfunction is referentially transparent if you could replace it with a static value.`),mdx(\"p\",null,\"class LightSwitch:\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`def toggle_light(self):\n    self.light_is_on = not self.light_is_on\n    return self.light_is_on\n\n@property\ndef is_on(self):\n    return self.light_is_on\n`)),mdx(\"p\",null,`In this class, the is_on method is referentially transparent - I can replace it with the\nvalue True or False without any loss of functionality, but the method toggle_light is\nside-effectual: replacing its calls with a static value would break the contracts of the\nsystem. To comply with the Command-Query separation principle, we should not return a\nvalue from our toggle_light method.`),mdx(\"p\",null,`In some languages we would say that the is_on method is \"pure\". The advantage of\nsplitting our functions into those that have side effects and those that are pure is\nthat the code becomes easier to reason about. Haskell loves pure functions, and uses\nthis reasonability to do strange things, like re-ordering your code for you at\ncompilation time to make it more efficient. For those of us who work in more prosaic\nlanguages, if commands and queries are clearly distinguished, then I can read through a\ncode base and understand all the ways in which state can change. This is a huge win for\ndebugging because there is nothing worse than troubleshooting a system when you can't\nwork out which code-paths are changing your data.`),mdx(\"p\",null,`How do we get data out of a Command-Handler architecture? When we're working in a\nCommand-Handler system we obviously use Commands and Handlers to perform state changes,\nbut what should we do when we want to get data back out of our model? What is the\nequivalent port for queries?`),mdx(\"p\",null,`The answer is \"it depends\". The lowest-cost option is just to re-use your repositories\nin your UI entrypoints.`),mdx(\"p\",null,`@app.route(\"/issues\") def list_issues(): with unit_of_work_manager.start() as\nunit_of_work: open_issues = unit_of_work.issues.find_by_status('open') return\njson.dumps(open_issues)`),mdx(\"p\",null,`This is totally fine unless you have complex formatting, or multiple entrypoints to your\nsystem. The problem with using your repositories directly in this way is that it's a\nslippery slope. Sooner or later you're going to have a tight deadline, and a simple\nrequirement, and the temptation is to skip all the command/handler nonsense and do it\ndirectly in the web api.`),mdx(\"p\",null,\"@app.route('/issues/\u003cissue_id\u003e', methods=\",\"['DELETE']\",`) def delete_issue(issue_id): with\nunit_of_work_manager.start() as uow: issue = uow.issues`,\"[issue_id]\",` issue.delete()\nuow.commit()`),mdx(\"p\",null,`Super convenient, but then you need to add some error handling and some logging and an\nemail notification.`),mdx(\"p\",null,\"@app.route('/issues/\u003cissue_id\u003e', methods=\",\"['DELETE']\",`) def delete_issue(issue_id):\nlogging.info(\"Handling DELETE of issue \"+str(issue_id))`),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`with unit_of_work_manager.start() as uow:\n   issue = uow.issues[issue_id]\n\n   if issue is None:\n       logging.warn(\"Issue not found\")\n       flask.abort(404)\n   if issue.status != 'deleted':\n      issue.delete()\n      uow.commit()\n      try:\n         smtp.send_notification(Issue.Deleted, issue_id)\n      except:\n         logging.error(\n            \"Failed to send email notification for deleted issue \"\n             + str(issue_id), exn_info=True)\n   else:\n      logging.info(\"Issue already deleted. NOOP\")\nreturn \"Deleted!\", 202\n`)),mdx(\"p\",null,`Aaaaand, we're back to where we started: business logic mixed with glue code, and the\nwhole mess slowly congealing in our web controllers. Of course, the slippery slope\nargument isn't a good reason not to do something, so if your queries are very simple,\nand you can avoid the temptation to do updates from your controllers, then you might as\nwell go ahead and read from repositories, it's all good, you have my blessing. If you\nwant to avoid this, because your reads are complex, or because you're trying to stay\npure, then instead we could define our views explicitly.`),mdx(\"p\",null,\"class OpenIssuesList:\"),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`def __init__(self, sessionmaker):\n    self.sessionmaker = sessionmaker\n\ndef fetch(self):\n    with self.sessionmaker() as session:\n        result = session.execute(\n            'SELECT reporter_name, timestamp, title\n             FROM issues WHERE state=\"open\"')\n        return [dict(r) for r in result.fetchall()]\n`)),mdx(\"p\",null,`@api.route('/issues/') def list_issues(): view_builder = OpenIssuesList(session_maker)\nreturn jsonify(view_builder.fetch())`),mdx(\"p\",null,`This is my favourite part of teaching ports and adapters to junior programmers, because\nthe conversation inevitably goes like this:`),mdx(\"p\",null,`smooth-faced youngling: Wow, um... are you - are we just going to hardcode that sql in\nthere? Just ... run it on the database?`),mdx(\"p\",null,`grizzled old architect: Yeah, I think so. Do The Simplest Thing That Could Possibly\nWork, right? YOLO, and so forth.`),mdx(\"p\",null,`sfy: Oh, okay. Um... but what about the unit of work and the domain model and the\nservice layer and the hexagonal stuff? Didn't you say that \"Data access ought to be\nperformed against the aggregate root for the use case, so that we maintain tight control\nof transactional boundaries\"?`),mdx(\"p\",null,\"goa: Ehhhh... I don't feel like doing that right now, I think I'm getting hungry.\"),mdx(\"p\",null,\"sfy: Right, right ... but what if your database schema changes?\"),mdx(\"p\",null,`goa: I guess I'll just come back and change that one line of SQL. My acceptance tests\nwill fail if I forget, so I can't get the code through CI.`),mdx(\"p\",null,`sfy: But why don't we use the Issue model we wrote? It seems weird to just ignore it and\nreturn this dict... and you said \"Avoid taking a dependency directly on frameworks. Work\nagainst an abstraction so that if your dependency changes, that doesn't force change to\nripple through your domain\". You know we can't unit test this, right?`),mdx(\"p\",null,`goa: Ha! What are you, some kind of architecture astronaut? Domain models! Who needs\n'em.`),mdx(\"p\",null,`Why have a separate read-model? In my experience, there are two ways that teams go wrong\nwhen using ORMs. The most common mistake is not paying enough attention to the\nboundaries of their use cases. This leads to the application making far too many calls\nto the database because people write code like this:`),mdx(\"h1\",null,\"Find all users who are assigned this task\"),mdx(\"h1\",null,\"[\",\"[and]\",\"] notify them and their line manager\"),mdx(\"h1\",null,\"then move the task to their in-queue\"),mdx(\"p\",null,`notification = task.as_notification() for assignee in task.assignees:\nassignee.manager.notifications.add(notification)\nassignee.notifications.add(notification) assignee.queues.inbox.add(task)`),mdx(\"p\",null,`ORMs make it very easy to \"dot\" through the object model this way, and pretend that we\nhave our data in memory, but this quickly leads to performance issues when the ORM\ngenerates hundreds of select statements in response. Then they get all angry about\nperformance and write long blog posts about how ORM sucks and is an anti-pattern and\nonly n00bs like it. This is akin to blaming OO for your domain logic ending up in the\ncontroller.`),mdx(\"p\",null,`The second mistake that teams make is using an ORM when they don't need to. Why do we\nuse an ORM in the first place? I think that a good ORM gives us two things:`),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},\"A unit of work pattern which can be used to control our consistency boundaries.\"),mdx(\"li\",{parentName:\"ol\"},`A data mapper pattern that lets us map a complex object graph to relational tables,\nwithout writing tons of boring glue code.`)),mdx(\"p\",null,`Taken together, these patterns help us to write rich domain models by removing all the\ndatabase cruft so we can focus on our use-cases. This allows us to model complex\nbusiness processes in an internally consistent way. When I'm writing a GET method,\nthough, I don't care about any of that. My view doesn't need any business logic, because\nit doesn't change any state. For 99.5% of use cases, it doesn't even matter if my data\nare fetched inside a transaction. If I perform a dirty read when listing the issues, one\nof three things might happen:`),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},`I might see changes that aren't yet committed - maybe an Issue that has just been\ndeleted will still show up in the list.`),mdx(\"li\",{parentName:\"ol\"},`I might not see changes that have been committed - an Issue could be missing from\nthe list, or a title might be 10ms out of date.`),mdx(\"li\",{parentName:\"ol\"},\"I might see duplicates of my data - an Issue could appear twice in the list.\")),mdx(\"p\",null,`In many systems all these occurrences are unlikely, and will be resolved by a page\nrefresh or following a link to view more data. To be clear, I'm not recommending that\nyou turn off transactions for your SELECT statements, just noting that transactional\nconsistency is usually only a real requirement when we are changing state. When viewing\nstate, we can almost always accept a weaker consistency model.`),mdx(\"p\",null,`CQRS is CQS at a system-level CQRS stands for Command-Query Responsibility Segregation,\nand it's an architectural pattern that was popularised by Greg Young. A lot of people\nmisunderstand CQRS, and think you need to use separate databases and crazy asynchronous\nprocessors to make it work. You can do these things, and I want to write more about that\nlater, but CQRS just means that we separate the Write Model - what we normally think of\nas the domain model - and the Read Model - a lightweight, simple model for showing on\nthe UI, or answering questions about the domain state.`),mdx(\"p\",null,`When I'm serving a write request (a command), my job is to protect the invariants of the\nsystem, and model the business process as it appears in the minds of our domain experts.\nI take the collective understanding of our business analysts, and turn it into a state\nmachine that makes useful work happen. When I'm serving a read request (a query), my job\nis to get the data out of the database as fast as possible and onto a screen so the user\ncan view it. Anything that gets in the way of my doing that is bloat.`),mdx(\"p\",null,`This isn't a new idea, or particularly controversial. We've all tried writing reports\nagainst an ORM, or complex hierarchical listing pages, and hit performance barriers.\nWhen we get to that point, the only thing we can do - short of rewriting the whole\nmodel, or abandoning our use of an ORM - is to rewrite our queries in raw SQL. Once upon\na time I'd feel bad for doing this, as though I were cheating, but nowadays I just\nrecognise that the requirements for my queries are fundamentally different than the\nrequirements for my commands.`),mdx(\"p\",null,`For the write-side of the system, use an ORM, for the read side, use whatever is a)\nfast, and b) convenient.`),mdx(\"p\",null,\"Application Controlled Identifiers At this point, a non-junior programmer will say\"),mdx(\"p\",null,`Okay, Mr Smarty-pants Architect, if our commands can't return any values, and our domain\nmodels don't know anything about the database, then how do I get an ID back from my save\nmethod? Let's say I create an API for creating new issues, and when I have POSTed the\nnew issue, I want to redirect the user to an endpoint where they can GET their new\nIssue. How can I get the id back?`),mdx(\"p\",null,`The way I would recommend you handle this is simple - instead of letting your database\nchoose ids for you, just choose them yourself.`),mdx(\"p\",null,\"@api.route('/issues', methods=\",\"['POST']\",`) def report_issue(self): # uuids make great\ndomain-controlled identifiers, because # they can be shared amongst several systems and\nare easy # to generate. issue_id = uuid.uuid4()`),mdx(\"pre\",null,mdx(\"code\",o({parentName:\"pre\"},{}),`cmd = ReportIssueCommand(issue_id, **request.get_json())\nhandler.handle(cmd)\nreturn \"\", 201, { 'Location': '/issues/' + str(issue_id) }\n`)),mdx(\"p\",null,`There's a few ways to do this, the most common is just to use a UUID, but you can also\nimplement something like hi-lo `,\"[https://pypi.python.org/pypi/sqlalchemy-hilo/0.1.2]\",`. In\nthe new code sample\n`,\"[https://github.com/bobthemighty/blog-code-samples/tree/master/ports-and-adapters/03]\",` ,\nI've implemented three flask endpoints, one to create a new issue, one to list all\nissues, and one to view a single issue. I'm using UUIDs as my identifiers, but I'm still\nusing an integer primary key on the issues table, because using a GUID in a clustered\nindex leads to table fragmentation and sadness\n`,\"[http://sqlmag.com/database-performance-tuning/clustered-indexes-based-upon-guids]\",\" .\"),mdx(\"p\",null,`Okay, quick spot-check - how are we shaping up against our original Ports and Adapters\ndiagram? How do the concepts map?`),mdx(\"p\",null,`Pretty well! Our domain is pure and doesn't know anything about infrastructure or IO. We\nhave a command and a handler that orchestrate a use-case, and we can drive our\napplication from tests or Flask. Most importantly, the layers on the outside depend on\nthe layers toward the centre.`),mdx(\"p\",null,\"Next time I'll get back to talking about message buses.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"date":"2017-09-13","title":"Commands and queries handlers and views","layout":"post","author":"Bob","categories":["ports \u0026 adapters"],"tags":["python","architecture"]},"__N_SSG":true},"page":"/[slug]","query":{"slug":"2017-09-13-commands-and-queries-handlers-and-views"},"buildId":"0V3tao8Q6Wc274G2cJ8zt","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>