<!DOCTYPE html><html><head><link rel="icon" href="https://media.made.com/mws-assets/images/favicon.1.ico"/><link media="screen,handheld" type="text/css" rel="stylesheet" href="https://media.made.com/mws-assets/fontBase_b900f8d534cc10f95604.css"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Dependency Injection with type signatures in python</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-f8fe1f0eb2299c5d.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-208998328ec77b24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ecae81f929857313.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-6e2954ca4f94f15d.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_buildManifest.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_ssgManifest.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_middlewareManifest.js" defer=""></script></head><body><script>(function setScript(initialValue) {
  var mql = window.matchMedia("(prefers-color-scheme: dark)");
  var systemPreference = mql.matches ? "dark" : "light";
  var persistedPreference;

  try {
    persistedPreference = localStorage.getItem("chakra-ui-color-mode");
  } catch (error) {
    console.log("Chakra UI: localStorage is not available. Color mode persistence might not work as expected");
  }

  var isInStorage = typeof persistedPreference === "string";
  var colorMode;

  if (isInStorage) {
    colorMode = persistedPreference;
  } else {
    colorMode = initialValue === "system" ? systemPreference : initialValue;
  }

  if (colorMode) {
    var root = document.documentElement;
    root.style.setProperty("--chakra-ui-color-mode", colorMode);
  }
})('light')</script><div id="__next"><style data-emotion="css-global 1vs9c57">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-5:#fff2f0;--chakra-colors-red-10:#ffdfdd;--chakra-colors-red-50:#F15856;--chakra-colors-red-80:#d03740;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-5:#e4fbe5;--chakra-colors-green-10:#ccf5ce;--chakra-colors-green-50:#30a75b;--chakra-colors-green-80:#008248;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-made-5:#fafafa;--chakra-colors-made-10:#f5f6f4;--chakra-colors-made-20:#eef0ed;--chakra-colors-made-30:#e1e3de;--chakra-colors-made-40:#bdbfbb;--chakra-colors-made-50:#9fa19d;--chakra-colors-made-60:#767874;--chakra-colors-made-70:#626360;--chakra-colors-made-80:#434442;--chakra-colors-made-90:#222321;--chakra-colors-made-black:#131413;--chakra-colors-made-baige:#d9c3b8;--chakra-colors-made-green:#c0d0cf;--chakra-colors-made-grey:#d7d3d0;--chakra-colors-made-blue:#353F7D;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:FS Neruda;--chakra-fonts-body:FS Meridian Regular,sans-serif;--chakra-fonts-mono:FS Hack;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1syi0wy">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 1baqkrf">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-gray-800);background:var(--chakra-colors-white);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}</style><style data-emotion="css mfxtb">.css-mfxtb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;box-shadow:var(--chakra-shadows-base);width:100%;margin-bottom:var(--chakra-space-8);padding:var(--chakra-space-8);}</style><header class="css-mfxtb"><style data-emotion="css 18ci58h">.css-18ci58h{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;max-width:var(--chakra-sizes-8xl);width:100%;margin:auto;}</style><div class="css-18ci58h"><div class="css-0"><a href="/"><img alt="Logo" src="https://media.made.com/mws-assets/images/MadeLogo.2.svg" class="chakra-image css-0" aria-label="Logo"/></a></div><style data-emotion="css 1wsmmqi">@media screen and (min-width: 30em){.css-1wsmmqi{display:block;}}@media screen and (min-width: 48em){.css-1wsmmqi{display:none;}}</style><div class="css-1wsmmqi"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div><style data-emotion="css 3txhs">.css-3txhs{display:none;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;margin-left:auto;}@media screen and (min-width: 48em){.css-3txhs{display:block;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;}}</style><div class="css-3txhs"><style data-emotion="css 1lpw2d">.css-1lpw2d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:var(--chakra-space-8);-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}@media screen and (min-width: 30em){.css-1lpw2d{-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 48em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 62em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}</style><div class="chakra-stack css-1lpw2d"><style data-emotion="css f4h6uy">.css-f4h6uy{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;}.css-f4h6uy:hover,.css-f4h6uy[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-f4h6uy:focus,.css-f4h6uy[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a target="" class="chakra-link css-f4h6uy" href="/"><style data-emotion="css 1twuvi0">.css-1twuvi0{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;width:100%;}.css-1twuvi0>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0.5rem;margin-inline-start:0.5rem;}</style><div class="chakra-stack css-1twuvi0"><p class="chakra-text css-0">Home</p></div></a><a target="_blank" class="chakra-link css-f4h6uy" href="https://www.made.com/careers"><div class="chakra-stack css-1twuvi0"><p class="chakra-text css-0">Careers</p><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></div></a></div></div></div></header><style data-emotion="css rkbxzj">.css-rkbxzj{width:100%;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;max-width:var(--chakra-sizes-4xl);-webkit-padding-start:1rem;padding-inline-start:1rem;-webkit-padding-end:1rem;padding-inline-end:1rem;}</style><div class="chakra-container css-rkbxzj"><style data-emotion="css 1xr7jem">.css-1xr7jem{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-5xl);line-height:1;margin-bottom:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-1xr7jem{font-size:var(--chakra-fontSizes-6xl);}}</style><h1 class="chakra-heading css-1xr7jem">Dependency Injection with type signatures in python</h1><style data-emotion="css 1iv087f">.css-1iv087f{margin-bottom:var(--chakra-space-2);font-weight:var(--chakra-fontWeights-bold);}</style><p class="chakra-text css-1iv087f">by <!-- -->Bob</p><style data-emotion="css b64cj9">.css-b64cj9{margin-bottom:var(--chakra-space-4);color:var(--chakra-colors-made-50);}</style><p class="chakra-text css-b64cj9">Fri Jun 15 2018</p><style data-emotion="css rszk63">.css-rszk63{margin-bottom:var(--chakra-space-4);}</style><p class="chakra-text css-rszk63">Dependency injection is not crazy, not un-pythonic, and not enterprisey. Here&#x27;s
Wikipedia:</p><p class="chakra-text css-rszk63">In software engineering, dependency injection is a technique whereby one object supplies
the dependencies of another object. A dependency is an object that can be used (a
service). An injection is the passing of a dependency to a dependent object (a client)
that would use it. The service is made part of the client&#x27;s state. The intent behind
dependency injection is to decouple objects to the extent that no client code has to be
changed simply because an object it depends on needs to be changed to a different one.</p><p class="chakra-text css-rszk63">In other words, Dependency Injection (DI, for all you jargon-fans out there) is when an
object is given its dependencies instead of reaching out to get them by itself. For
example, in this series we&#x27;re building a system for managing IT support issues. Last
time we had a requirement to send an email when an issue was assigned to an engineer.
Our handler is orchestration code that plugs together two collaborators: a View Builder
that fetches data, and an Email Sender that knows how to send an email to the mail
server.</p><pre><style data-emotion="css 77j1of">.css-77j1of{background:var(--chakra-colors-orange-50);border-radius:10px;margin-bottom:var(--chakra-space-10);font-size:var(--chakra-fontSizes-sm);box-shadow:var(--chakra-shadows-lg);}</style><div class="chakra-wrap css-77j1of"><style data-emotion="css umyqv7">.css-umyqv7{--chakra-wrap-spacing:0.5rem;--wrap-spacing:calc(var(--chakra-wrap-spacing) / 2);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;list-style-type:none;padding:0px;margin:calc(var(--wrap-spacing) * -1);}.css-umyqv7>*:not(style){margin:var(--wrap-spacing);}</style><ul class="chakra-wrap__list css-umyqv7"><style data-emotion="css r4358i">.css-r4358i{padding:var(--chakra-space-5);}</style><div class="css-r4358i">class IssueAssignedHandler:

    def __init__(self, sender: EmailSender, view: IssueViewBuilder):
        self.sender = sender
        self.view = view

    def handle(self, msg):
        data = self.view.fetch(cmd.issue_id)
        sender.send_email(emails.IssueAssigned, data)
</div></ul></div></pre><p class="chakra-text css-rszk63">This is dependency injection. We&#x27;re injecting the dependencies (the sender and view) by
making them parameters of the constructor. That&#x27;s it. Passing our parameters this way
makes them more explicit, and so reduces the overall quantity of Unpleasant Surprise
hiding in the system. Because I&#x27;m providing all my dependencies from outside of my
handler, I can change them easily, or provide fakes. This helps to keep the system
loosely-coupled and flexible. It also means that I have to think about what the
dependencies of my system ought to be, and that helps me to define meaningful
abstractions.</p><p class="chakra-text css-rszk63">Dependency injection is really just a way of performing
<style data-emotion="css 1ud5qxa">.css-1ud5qxa{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:var(--chakra-colors-made-blue);}.css-1ud5qxa:hover,.css-1ud5qxa[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-1ud5qxa:focus,.css-1ud5qxa[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a target="_blank" class="chakra-link css-1ud5qxa" href="https://www.pydanny.com/python-partials-are-fun.html">partial application</a> on a method
call. Earlier in this series, I said that I often create handlers by abusing the
<code>__call__</code> magic method.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class IssueAssignedHandler:

    def __init__(self, sender, view):
        self.view = view
        self.sender = sender

    def __call__(self, cmd):
        data = self.view.fetch(cmd.issue_id)
        sender.send_email(emails.IssueAssigned, data)

handler = IssueAssignedHandler(sender, view) handler(cmd)
</div></ul></div></pre><p class="chakra-text css-rszk63">Calling the constructor of IssueAssignedHandler returns a callable. Compare that with
the following examples of partial application:</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">def explicit_closure_handler(self, sender, view):

    def h(self, cmd):
        data = view.fetch(cmd.issue_id)
        ...
    return h


handler_a = explicit_closure_handler(sender, view) handler_a(cmd)

from functools import partial def send_assignment_email(sender, view, cmd): data =
view.fetch(cmd.issue_id) ...

handler_b = partial(send_assignment_email, sender, view) handler_b(cmd)
</div></ul></div></pre><p class="chakra-text css-rszk63">The callables handler, handler_a, and handler_b all take a single argument (the command)
and run the same code on it, so we can see that they are functionally equivalent.
Dependency injection is just a way of parametising the behaviour of our applications by
partially applying function arguments.</p><p class="chakra-text css-rszk63">The advantage of building a system this way is that it&#x27;s very easy to test, configure,
and extend the behaviour of our application through composition. Dynamic languages offer
many ways to fake the behaviour of a component, but my preference is to write explicit
fakes and stubs, and to pass them as constructor arguments. This forces me to think
about my system in terms of composable parts, and to identify the roles that they play.
Instead of directly calling the database from my handler, I&#x27;m providing an
IssueViewBuilder. Instead of writing a load of SMTP code in my handler, I&#x27;m providing an
instance of EmailSender.</p><p class="chakra-text css-rszk63">This, for me at least, is the simplest, most obvious, and least magical way of dealing
with dependencies, especially across architectural boundaries. Performing dependency
injection - whether by constructor injection or partial application, or some magic
property-filling decorator - is mandatory if you want to do ports and adapters. It&#x27;s the
&quot;one weird trick&quot; that allows high-level code (business logic) to remain completely
isolated from low level code (database transactions, file operations, email sending
etc.)</p><p class="chakra-text css-rszk63">You don&#x27;t need to use a framework for DI Dependency injection gets a bad rap in the
Python community for reasons that escape me. I think it&#x27;s because people assume that you
need to use a framework to perform the injection, and they&#x27;re terrified of ending up in
an xml-driven hellscape like
<a target="_blank" class="chakra-link css-1ud5qxa" href="https://memorynotfound.com/spring-mvc-xml-configuration-example/">Spring</a>. This isn&#x27;t
true, you can still perform dependency injection with no frameworks at all. For example,
in the code sample for the previous part in this series, I extracted all my wiring into
a single module with boring code that looks like this:</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">db = SqlAlchemy(&#x27;sqlite:///issues.db&#x27;) db.configure_mappings() db.create_schema()

bus = MessageBus() db.associate_message_bus(bus)

issue_view_builder = IssueViewBuilder(db) issue_list_builder = IssueListBuilder(db)

report_issue = ReportIssueHandler(db.unit_of_work_manager) assign_issue =
AssignIssueHandler(db.unit_of_work_manager) triage_issue =
TriageIssueHandler(db.unit_of_work_manager) issue_assigned =
IssueAssignedHandler(issue_view_builder, LoggingEmailSender())
bus.subscribe_to(msg.ReportIssueCommand, report_issue)
bus.subscribe_to(msg.TriageIssueCommand, triage_issue)
bus.subscribe_to(msg.IssueAssignedToEngineer, issue_assigned)
bus.subscribe_to(msg.AssignIssueCommand, assign_issue)
</div></ul></div></pre><p class="chakra-text css-rszk63">This code is just a straight-line script that configures the database, creates all of
our message handlers, and then registers them with the message bus. This component is
what an architect would call a
<a target="_blank" class="chakra-link css-1ud5qxa" href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">Composition Root</a>. On my current
teams, we tend to call this a bootstrap script. As systems grow, though, and
requirements become more complex, this bootstrapper script can become more repetitive
and error-prone. Dependency injection frameworks exist to remove some of the
boiler-plate around registering and wiring up dependencies. In recent years the
.Net-hipster crowd have started to move away from complex dependency injection
containers in favour of simpler composition roots. This is variously known as poor man&#x27;s
DI, pure DI, or artisinal organic acorn-fed DI.</p><p class="chakra-text css-rszk63">Usually, on our Python projects at Made.com, we use the
<a target="_blank" class="chakra-link css-1ud5qxa" href="https://pypi.python.org/pypi/Inject/3.1.1">inject</a> library. This is a simple tool that
performs the partial application trick I demonstrated above. Inject is my favourite of
the Python DI libraries because it&#x27;s so simple to use, but I have a dislike for its use
of decorators to declare dependencies.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">import inject

# client code

class IssueAssignedHandler:

    @inject(sender=&#x27;email_sender&#x27;, view=&#x27;issue_view_builder&#x27;)
    def __init__(self, sender, view):
        pass

    def handle(self, cmd):
        pass


# configuration

def configure_binder(binder): db = SqlAlchemy(&#x27;sqlite://&#x27;)
    binder.bind(&#x27;email_sender&#x27;, SmtpEmailSender(host=..., port=..., username=...))
    binder.bind(&#x27;issue_view_builder&#x27;, IssueViewBuilder)

    inject.configure(configure_binder)

    handler = IssueAssignedHandler()
</div></ul></div></pre><p class="chakra-text css-rszk63">The configure_binder function takes the place of my bootstrap script in wiring up and
configuring my dependencies. When I call IssueAssignedHandler the inject library knows
that it should replace the sender param with the configured SmtpEmailSender, and that it
should replace the view param with an IssueViewBuilder. The decorator serves to
associate the service (&quot;email_sender&quot;) with the parameter (&quot;sender&quot;), but it always
feels inappropriate to have this kind of declaration outside of my composition root.</p><p class="chakra-text css-rszk63">I&#x27;ve been working on a <a target="_blank" class="chakra-link css-1ud5qxa" href="https://github.com/bobthemighty/punq">prototype DI framework</a>
that avoids this problem by using
<a target="_blank" class="chakra-link css-1ud5qxa" href="https://docs.python.org/3/library/typing.html">Python 3.6&#x27;s optional type hinting</a>, and
I&#x27;d like to show you some use cases.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">import punq

# client code

class IssueAssignedHandler: # We use type hints to declare what dependencies we need def
    def __init__(self, sender: EmailSender, view: IssueViewBuilder):
        self.sender = sender
    self.view = view

    def handle(self, cmd):
        pass

# configuration

container = punq.container()

# We can register a singleton instance of a dependency

container.register(EmailSender, SmtpEmailSender(host=..., port=..))

# Or a class that implements a particular service

container.register(UnitOfWorkManager, SqlAlchemyUnitOfWorkManager)

# Or register the service itself

container.register(IssueViewBuilder)

handler = container.resolve(IssueAssignedHandler)
</div></ul></div></pre><p class="chakra-text css-rszk63">So far, so underwhelming. Simple registrations don&#x27;t really save us anything over the
bootstrap script from earlier. Using a container for this kind of work really only cuts
down on duplication - when I&#x27;ve registered UnitOfWorkManager once, I never have to refer
to it again, whereas in the bootstrap I had to explicitly pass it to every handler. It&#x27;s
nice not having to decorate my class with dependency injection specific noise though,
instead I can just declare what my dependencies are. As an added bonus, I can run mypy
over my code and it will tell me if I&#x27;ve made any stupid type errors.</p><p class="chakra-text css-rszk63">There are more useful things we can do with a dependency injection container, though.
For example, maybe we&#x27;re writing a program that needs to run a bunch of processing rules
over some text. We decide to treat each processing rule as a function and use our
container to fetch them all at runtime.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i"># string_processing_rule is just an alias

# for a function of str -&gt; str

string_processing_rule = Callable[[str], str]

class StringProcessor:

    def __init__(self, rules: List[string_processing_rule]):
        self.rules = rules

    def process(self, input):
        for rules in self.rules:
            input = rule(input)
        return input

def upper_case(input: str) -&gt; str:
    return str.upper()

def reverse(input: str) -&gt; str:
    return reversed(str)

container = punq.container() container.register(string_processing_rule, upper_case)
container.register(string_processing_rule, reverse)

processor = container.resolve(StringProcessor)

# prints (&quot;DLORW OLLEH&quot;)

print(processor.process(&quot;hello world&quot;))
</div></ul></div></pre><p class="chakra-text css-rszk63">One of the advantages of using types over using other keys is that they&#x27;re composable. I
can ask for a List<!-- -->[T]<!-- --> and get all registered instances of some T. This is handy when
you&#x27;re writing code that processes the same message with a bunch on different steps,
including rules engines and message buses. Having generics in our type system can make
it easier to manage all of our dependencies in other ways, too. For example, I can use
generics to automatically wire up all my message handlers.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class IssueAssignedHandler (Handles[IssueAssignedEvent]): pass
</div></ul></div></pre><p class="chakra-text css-rszk63">Here we&#x27;re stating that our IssueAssignedHandler is an subtype of the Handles class, and
it has a type parameter for the handled event. Given a module full of these, I can
enumerate the module&#x27;s types and perform automatic registration.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">def register_all(module):
    &quot;&quot;&quot; Read through all the types in a module and register them
    if they are handlers&quot;&quot;&quot;

    for _, type in inspect.getmembers(module, predicate=inspect.isclass):
        register(type)

def register(type):
    &quot;&quot;&quot; If this type is a handler type then register it in the container&quot;&quot;&quot;
    handler_service_type = get_message_type(type)
    if handler_service_type is None:
        return container.register(handler_service_type, type)

def get_message_type(type):
    &quot;&quot;&quot; If this type subclasses the Handles[TMsg] class, return
    the parameterised type. eg. for our IssueAssignedHandler, this would return
    Handles[IssueAssignedEvent] &quot;&quot;&quot;

    try:
        for base in type.__orig_bases__:
            if base.__origin__ == services.Handles:
              return base
    except Exception:
        pass

def resolve_handler(event_type):
    container.resolve(Handles[event_type])

class MessageHandler:
    def handle(self, next:MessageHandler):
        pass

class LoggingHandler:

    def __init__(self, next: MessageHandler):
        self.next = next

    def handle(self, msg):
        logging.info(&quot;Handling message %s&quot;, msg)
        next.handle(msg)

class DefaultHandler:

    def __init__(self, next: MessageHandler, container:punq.Container):
        self.next = next
        self.container = container

    def handle(self, msg):
        handler = container.resolve(Handles[type(msg)])
        handler.handle(msg)

container.register(MessageHandler, DefaultHandler)
container.register(MessageHandler, LoggingHandler)

container.register(Handles[IssueAssigned], IssueAssignedHandler)

bus = container.resolve(MessageBus)

# calls logging handler, and then DefaultHandler

bus.handle(msg)
</div></ul></div></pre><p class="chakra-text css-rszk63">Because each MessageHandler depends on another MessageHandler, punq treats them as a
chain, and injects them into each other like a stack of Russian dolls. I can hear the
Python faithful baying for blood at this point. Why would anyone want to do this when
Python already has such great support for decorators? The only reason to ever do this in
Python is if you want to inject dependencies into your decorators. In the following code
we add two new message handlers, a metrics handler that records the runtime of our
handler pipeline so we can monitor our application, and a de-duplicating handler that
prevents us from handling the same message twice. Both of these require complex
dependencies of their own, so we can delegate their creation to the container.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class MetricsGatheringHandler(MessageHandler):

    def __init__(self, metrics: MetricsCollector, next: MessageHandler):
        self.metrics = metrics

    def handle(self, msg):
        # Record the time taken when we process a message
        with self.metrics.time(&#x27;command/execution-time&#x27;):
            self.next.handle(msg)

class DedeuplicatingHandler (MessageHandler):

    def __init__(self, filter:MessageFilter, next:MessageHandler):
        self.next = next
        self.filter = filter

    def handle(self, msg):
        if self.filter.is_duplicate(msg):
            logging.warn(&quot;msg %s is a duplicate. Skipping&quot;, msg)
            return

        try:
            self.next.handle(msg)
        finally:
            self.filter.record(msg.id)

ontainer.register(MetricsCollector, StatsdMetricsCollector)
container.register(MessageFilter, InMemoryMessageFilter)
container.register(MessageHandler, MetricsGatheringHandler)
container.register(MessageHandler, DedeuplicatingHandler)
</div></ul></div></pre><style data-emotion="css 1i61012">.css-1i61012{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-6xl);line-height:1;}@media screen and (min-width: 48em){.css-1i61012{font-size:var(--chakra-fontSizes-7xl);}}</style><h1 class="chakra-heading css-1i61012">Deduplicates, records metrics, writes a log file, and invokes our Command Handler</h1><p class="chakra-text css-rszk63">container.resolve(MessageHandler).handle(msg)</p><p class="chakra-text css-rszk63">This is what I meant in the last part when I said that a message bus is a great place to
put cross-cutting concerns. Validation, exception handling, db session management, and
basic logging are all great candidates for decorators on our message bus, and DI makes
it easy for us to write and test those components separately. Next time I want to get
back to the issues codebase and talk about how ports and adapters helps provide
technology agnosticism.</p></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var p=Object.defineProperty,h=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var i=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable;var d=(e,n,t)=\u003en in e?p(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,s=(e,n)=\u003e{for(var t in n||(n={}))r.call(n,t)\u0026\u0026d(e,t,n[t]);if(i)for(var t of i(n))o.call(n,t)\u0026\u0026d(e,t,n[t]);return e},l=(e,n)=\u003eh(e,u(n));var c=(e,n)=\u003e{var t={};for(var a in e)r.call(e,a)\u0026\u0026n.indexOf(a)\u003c0\u0026\u0026(t[a]=e[a]);if(e!=null\u0026\u0026i)for(var a of i(e))n.indexOf(a)\u003c0\u0026\u0026o.call(e,a)\u0026\u0026(t[a]=e[a]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var a=t,{components:e}=a,n=c(a,[\"components\"]);return mdx(MDXLayout,l(s(s({},layoutProps),n),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`Dependency injection is not crazy, not un-pythonic, and not enterprisey. Here's\nWikipedia:`),mdx(\"p\",null,`In software engineering, dependency injection is a technique whereby one object supplies\nthe dependencies of another object. A dependency is an object that can be used (a\nservice). An injection is the passing of a dependency to a dependent object (a client)\nthat would use it. The service is made part of the client's state. The intent behind\ndependency injection is to decouple objects to the extent that no client code has to be\nchanged simply because an object it depends on needs to be changed to a different one.`),mdx(\"p\",null,`In other words, Dependency Injection (DI, for all you jargon-fans out there) is when an\nobject is given its dependencies instead of reaching out to get them by itself. For\nexample, in this series we're building a system for managing IT support issues. Last\ntime we had a requirement to send an email when an issue was assigned to an engineer.\nOur handler is orchestration code that plugs together two collaborators: a View Builder\nthat fetches data, and an Email Sender that knows how to send an email to the mail\nserver.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`class IssueAssignedHandler:\n\n    def __init__(self, sender: EmailSender, view: IssueViewBuilder):\n        self.sender = sender\n        self.view = view\n\n    def handle(self, msg):\n        data = self.view.fetch(cmd.issue_id)\n        sender.send_email(emails.IssueAssigned, data)\n`)),mdx(\"p\",null,`This is dependency injection. We're injecting the dependencies (the sender and view) by\nmaking them parameters of the constructor. That's it. Passing our parameters this way\nmakes them more explicit, and so reduces the overall quantity of Unpleasant Surprise\nhiding in the system. Because I'm providing all my dependencies from outside of my\nhandler, I can change them easily, or provide fakes. This helps to keep the system\nloosely-coupled and flexible. It also means that I have to think about what the\ndependencies of my system ought to be, and that helps me to define meaningful\nabstractions.`),mdx(\"p\",null,`Dependency injection is really just a way of performing\n`,mdx(\"a\",s({parentName:\"p\"},{href:\"https://www.pydanny.com/python-partials-are-fun.html\"}),\"partial application\"),` on a method\ncall. Earlier in this series, I said that I often create handlers by abusing the\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"__call__\"),\" magic method.\"),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`class IssueAssignedHandler:\n\n    def __init__(self, sender, view):\n        self.view = view\n        self.sender = sender\n\n    def __call__(self, cmd):\n        data = self.view.fetch(cmd.issue_id)\n        sender.send_email(emails.IssueAssigned, data)\n\nhandler = IssueAssignedHandler(sender, view) handler(cmd)\n`)),mdx(\"p\",null,`Calling the constructor of IssueAssignedHandler returns a callable. Compare that with\nthe following examples of partial application:`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{}),`def explicit_closure_handler(self, sender, view):\n\n    def h(self, cmd):\n        data = view.fetch(cmd.issue_id)\n        ...\n    return h\n\n\nhandler_a = explicit_closure_handler(sender, view) handler_a(cmd)\n\nfrom functools import partial def send_assignment_email(sender, view, cmd): data =\nview.fetch(cmd.issue_id) ...\n\nhandler_b = partial(send_assignment_email, sender, view) handler_b(cmd)\n`)),mdx(\"p\",null,`The callables handler, handler_a, and handler_b all take a single argument (the command)\nand run the same code on it, so we can see that they are functionally equivalent.\nDependency injection is just a way of parametising the behaviour of our applications by\npartially applying function arguments.`),mdx(\"p\",null,`The advantage of building a system this way is that it's very easy to test, configure,\nand extend the behaviour of our application through composition. Dynamic languages offer\nmany ways to fake the behaviour of a component, but my preference is to write explicit\nfakes and stubs, and to pass them as constructor arguments. This forces me to think\nabout my system in terms of composable parts, and to identify the roles that they play.\nInstead of directly calling the database from my handler, I'm providing an\nIssueViewBuilder. Instead of writing a load of SMTP code in my handler, I'm providing an\ninstance of EmailSender.`),mdx(\"p\",null,`This, for me at least, is the simplest, most obvious, and least magical way of dealing\nwith dependencies, especially across architectural boundaries. Performing dependency\ninjection - whether by constructor injection or partial application, or some magic\nproperty-filling decorator - is mandatory if you want to do ports and adapters. It's the\n\"one weird trick\" that allows high-level code (business logic) to remain completely\nisolated from low level code (database transactions, file operations, email sending\netc.)`),mdx(\"p\",null,`You don't need to use a framework for DI Dependency injection gets a bad rap in the\nPython community for reasons that escape me. I think it's because people assume that you\nneed to use a framework to perform the injection, and they're terrified of ending up in\nan xml-driven hellscape like\n`,mdx(\"a\",s({parentName:\"p\"},{href:\"https://memorynotfound.com/spring-mvc-xml-configuration-example/\"}),\"Spring\"),`. This isn't\ntrue, you can still perform dependency injection with no frameworks at all. For example,\nin the code sample for the previous part in this series, I extracted all my wiring into\na single module with boring code that looks like this:`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`db = SqlAlchemy('sqlite:///issues.db') db.configure_mappings() db.create_schema()\n\nbus = MessageBus() db.associate_message_bus(bus)\n\nissue_view_builder = IssueViewBuilder(db) issue_list_builder = IssueListBuilder(db)\n\nreport_issue = ReportIssueHandler(db.unit_of_work_manager) assign_issue =\nAssignIssueHandler(db.unit_of_work_manager) triage_issue =\nTriageIssueHandler(db.unit_of_work_manager) issue_assigned =\nIssueAssignedHandler(issue_view_builder, LoggingEmailSender())\nbus.subscribe_to(msg.ReportIssueCommand, report_issue)\nbus.subscribe_to(msg.TriageIssueCommand, triage_issue)\nbus.subscribe_to(msg.IssueAssignedToEngineer, issue_assigned)\nbus.subscribe_to(msg.AssignIssueCommand, assign_issue)\n`)),mdx(\"p\",null,`This code is just a straight-line script that configures the database, creates all of\nour message handlers, and then registers them with the message bus. This component is\nwhat an architect would call a\n`,mdx(\"a\",s({parentName:\"p\"},{href:\"http://blog.ploeh.dk/2011/07/28/CompositionRoot/\"}),\"Composition Root\"),`. On my current\nteams, we tend to call this a bootstrap script. As systems grow, though, and\nrequirements become more complex, this bootstrapper script can become more repetitive\nand error-prone. Dependency injection frameworks exist to remove some of the\nboiler-plate around registering and wiring up dependencies. In recent years the\n.Net-hipster crowd have started to move away from complex dependency injection\ncontainers in favour of simpler composition roots. This is variously known as poor man's\nDI, pure DI, or artisinal organic acorn-fed DI.`),mdx(\"p\",null,`Usually, on our Python projects at Made.com, we use the\n`,mdx(\"a\",s({parentName:\"p\"},{href:\"https://pypi.python.org/pypi/Inject/3.1.1\"}),\"inject\"),` library. This is a simple tool that\nperforms the partial application trick I demonstrated above. Inject is my favourite of\nthe Python DI libraries because it's so simple to use, but I have a dislike for its use\nof decorators to declare dependencies.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`import inject\n\n# client code\n\nclass IssueAssignedHandler:\n\n    @inject(sender='email_sender', view='issue_view_builder')\n    def __init__(self, sender, view):\n        pass\n\n    def handle(self, cmd):\n        pass\n\n\n# configuration\n\ndef configure_binder(binder): db = SqlAlchemy('sqlite://')\n    binder.bind('email_sender', SmtpEmailSender(host=..., port=..., username=...))\n    binder.bind('issue_view_builder', IssueViewBuilder)\n\n    inject.configure(configure_binder)\n\n    handler = IssueAssignedHandler()\n`)),mdx(\"p\",null,`The configure_binder function takes the place of my bootstrap script in wiring up and\nconfiguring my dependencies. When I call IssueAssignedHandler the inject library knows\nthat it should replace the sender param with the configured SmtpEmailSender, and that it\nshould replace the view param with an IssueViewBuilder. The decorator serves to\nassociate the service (\"email_sender\") with the parameter (\"sender\"), but it always\nfeels inappropriate to have this kind of declaration outside of my composition root.`),mdx(\"p\",null,\"I've been working on a \",mdx(\"a\",s({parentName:\"p\"},{href:\"https://github.com/bobthemighty/punq\"}),\"prototype DI framework\"),`\nthat avoids this problem by using\n`,mdx(\"a\",s({parentName:\"p\"},{href:\"https://docs.python.org/3/library/typing.html\"}),\"Python 3.6's optional type hinting\"),`, and\nI'd like to show you some use cases.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`import punq\n\n# client code\n\nclass IssueAssignedHandler: # We use type hints to declare what dependencies we need def\n    def __init__(self, sender: EmailSender, view: IssueViewBuilder):\n        self.sender = sender\n    self.view = view\n\n    def handle(self, cmd):\n        pass\n\n# configuration\n\ncontainer = punq.container()\n\n# We can register a singleton instance of a dependency\n\ncontainer.register(EmailSender, SmtpEmailSender(host=..., port=..))\n\n# Or a class that implements a particular service\n\ncontainer.register(UnitOfWorkManager, SqlAlchemyUnitOfWorkManager)\n\n# Or register the service itself\n\ncontainer.register(IssueViewBuilder)\n\nhandler = container.resolve(IssueAssignedHandler)\n`)),mdx(\"p\",null,`So far, so underwhelming. Simple registrations don't really save us anything over the\nbootstrap script from earlier. Using a container for this kind of work really only cuts\ndown on duplication - when I've registered UnitOfWorkManager once, I never have to refer\nto it again, whereas in the bootstrap I had to explicitly pass it to every handler. It's\nnice not having to decorate my class with dependency injection specific noise though,\ninstead I can just declare what my dependencies are. As an added bonus, I can run mypy\nover my code and it will tell me if I've made any stupid type errors.`),mdx(\"p\",null,`There are more useful things we can do with a dependency injection container, though.\nFor example, maybe we're writing a program that needs to run a bunch of processing rules\nover some text. We decide to treat each processing rule as a function and use our\ncontainer to fetch them all at runtime.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`# string_processing_rule is just an alias\n\n# for a function of str -\u003e str\n\nstring_processing_rule = Callable[[str], str]\n\nclass StringProcessor:\n\n    def __init__(self, rules: List[string_processing_rule]):\n        self.rules = rules\n\n    def process(self, input):\n        for rules in self.rules:\n            input = rule(input)\n        return input\n\ndef upper_case(input: str) -\u003e str:\n    return str.upper()\n\ndef reverse(input: str) -\u003e str:\n    return reversed(str)\n\ncontainer = punq.container() container.register(string_processing_rule, upper_case)\ncontainer.register(string_processing_rule, reverse)\n\nprocessor = container.resolve(StringProcessor)\n\n# prints (\"DLORW OLLEH\")\n\nprint(processor.process(\"hello world\"))\n`)),mdx(\"p\",null,`One of the advantages of using types over using other keys is that they're composable. I\ncan ask for a List`,\"[T]\",` and get all registered instances of some T. This is handy when\nyou're writing code that processes the same message with a bunch on different steps,\nincluding rules engines and message buses. Having generics in our type system can make\nit easier to manage all of our dependencies in other ways, too. For example, I can use\ngenerics to automatically wire up all my message handlers.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`class IssueAssignedHandler (Handles[IssueAssignedEvent]): pass\n`)),mdx(\"p\",null,`Here we're stating that our IssueAssignedHandler is an subtype of the Handles class, and\nit has a type parameter for the handled event. Given a module full of these, I can\nenumerate the module's types and perform automatic registration.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`def register_all(module):\n    \"\"\" Read through all the types in a module and register them\n    if they are handlers\"\"\"\n\n    for _, type in inspect.getmembers(module, predicate=inspect.isclass):\n        register(type)\n\ndef register(type):\n    \"\"\" If this type is a handler type then register it in the container\"\"\"\n    handler_service_type = get_message_type(type)\n    if handler_service_type is None:\n        return container.register(handler_service_type, type)\n\ndef get_message_type(type):\n    \"\"\" If this type subclasses the Handles[TMsg] class, return\n    the parameterised type. eg. for our IssueAssignedHandler, this would return\n    Handles[IssueAssignedEvent] \"\"\"\n\n    try:\n        for base in type.__orig_bases__:\n            if base.__origin__ == services.Handles:\n              return base\n    except Exception:\n        pass\n\ndef resolve_handler(event_type):\n    container.resolve(Handles[event_type])\n\nclass MessageHandler:\n    def handle(self, next:MessageHandler):\n        pass\n\nclass LoggingHandler:\n\n    def __init__(self, next: MessageHandler):\n        self.next = next\n\n    def handle(self, msg):\n        logging.info(\"Handling message %s\", msg)\n        next.handle(msg)\n\nclass DefaultHandler:\n\n    def __init__(self, next: MessageHandler, container:punq.Container):\n        self.next = next\n        self.container = container\n\n    def handle(self, msg):\n        handler = container.resolve(Handles[type(msg)])\n        handler.handle(msg)\n\ncontainer.register(MessageHandler, DefaultHandler)\ncontainer.register(MessageHandler, LoggingHandler)\n\ncontainer.register(Handles[IssueAssigned], IssueAssignedHandler)\n\nbus = container.resolve(MessageBus)\n\n# calls logging handler, and then DefaultHandler\n\nbus.handle(msg)\n`)),mdx(\"p\",null,`Because each MessageHandler depends on another MessageHandler, punq treats them as a\nchain, and injects them into each other like a stack of Russian dolls. I can hear the\nPython faithful baying for blood at this point. Why would anyone want to do this when\nPython already has such great support for decorators? The only reason to ever do this in\nPython is if you want to inject dependencies into your decorators. In the following code\nwe add two new message handlers, a metrics handler that records the runtime of our\nhandler pipeline so we can monitor our application, and a de-duplicating handler that\nprevents us from handling the same message twice. Both of these require complex\ndependencies of their own, so we can delegate their creation to the container.`),mdx(\"pre\",null,mdx(\"code\",s({parentName:\"pre\"},{className:\"language-python\"}),`class MetricsGatheringHandler(MessageHandler):\n\n    def __init__(self, metrics: MetricsCollector, next: MessageHandler):\n        self.metrics = metrics\n\n    def handle(self, msg):\n        # Record the time taken when we process a message\n        with self.metrics.time('command/execution-time'):\n            self.next.handle(msg)\n\nclass DedeuplicatingHandler (MessageHandler):\n\n    def __init__(self, filter:MessageFilter, next:MessageHandler):\n        self.next = next\n        self.filter = filter\n\n    def handle(self, msg):\n        if self.filter.is_duplicate(msg):\n            logging.warn(\"msg %s is a duplicate. Skipping\", msg)\n            return\n\n        try:\n            self.next.handle(msg)\n        finally:\n            self.filter.record(msg.id)\n\nontainer.register(MetricsCollector, StatsdMetricsCollector)\ncontainer.register(MessageFilter, InMemoryMessageFilter)\ncontainer.register(MessageHandler, MetricsGatheringHandler)\ncontainer.register(MessageHandler, DedeuplicatingHandler)\n`)),mdx(\"h1\",null,\"Deduplicates, records metrics, writes a log file, and invokes our Command Handler\"),mdx(\"p\",null,\"container.resolve(MessageHandler).handle(msg)\"),mdx(\"p\",null,`This is what I meant in the last part when I said that a message bus is a great place to\nput cross-cutting concerns. Validation, exception handling, db session management, and\nbasic logging are all great candidates for decorators on our message bus, and DI makes\nit easy for us to write and test those components separately. Next time I want to get\nback to the issues codebase and talk about how ports and adapters helps provide\ntechnology agnosticism.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"date":"2018-06-15","title":"Dependency Injection with type signatures in python","layout":"post","author":"Bob","categories":["ports \u0026 adapters"],"tags":["python","architecture"]},"__N_SSG":true},"page":"/[slug]","query":{"slug":"2018-06-15-dependency-injection-with-type-signatures-in-python"},"buildId":"hH0eCY_oB5qaF9gyvL6n1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>