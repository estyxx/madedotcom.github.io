<!DOCTYPE html><html><head><link rel="icon" href="https://media.made.com/mws-assets/images/favicon.1.ico"/><link media="screen,handheld" type="text/css" rel="stylesheet" href="https://media.made.com/mws-assets/fontBase_b900f8d534cc10f95604.css"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Repositoriy and unit of work pattern in python</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-f8fe1f0eb2299c5d.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-208998328ec77b24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ecae81f929857313.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-6e2954ca4f94f15d.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_buildManifest.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_ssgManifest.js" defer=""></script><script src="/_next/static/hH0eCY_oB5qaF9gyvL6n1/_middlewareManifest.js" defer=""></script></head><body><script>(function setScript(initialValue) {
  var mql = window.matchMedia("(prefers-color-scheme: dark)");
  var systemPreference = mql.matches ? "dark" : "light";
  var persistedPreference;

  try {
    persistedPreference = localStorage.getItem("chakra-ui-color-mode");
  } catch (error) {
    console.log("Chakra UI: localStorage is not available. Color mode persistence might not work as expected");
  }

  var isInStorage = typeof persistedPreference === "string";
  var colorMode;

  if (isInStorage) {
    colorMode = persistedPreference;
  } else {
    colorMode = initialValue === "system" ? systemPreference : initialValue;
  }

  if (colorMode) {
    var root = document.documentElement;
    root.style.setProperty("--chakra-ui-color-mode", colorMode);
  }
})('light')</script><div id="__next"><style data-emotion="css-global 1vs9c57">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-5:#fff2f0;--chakra-colors-red-10:#ffdfdd;--chakra-colors-red-50:#F15856;--chakra-colors-red-80:#d03740;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-5:#e4fbe5;--chakra-colors-green-10:#ccf5ce;--chakra-colors-green-50:#30a75b;--chakra-colors-green-80:#008248;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-made-5:#fafafa;--chakra-colors-made-10:#f5f6f4;--chakra-colors-made-20:#eef0ed;--chakra-colors-made-30:#e1e3de;--chakra-colors-made-40:#bdbfbb;--chakra-colors-made-50:#9fa19d;--chakra-colors-made-60:#767874;--chakra-colors-made-70:#626360;--chakra-colors-made-80:#434442;--chakra-colors-made-90:#222321;--chakra-colors-made-black:#131413;--chakra-colors-made-baige:#d9c3b8;--chakra-colors-made-green:#c0d0cf;--chakra-colors-made-grey:#d7d3d0;--chakra-colors-made-blue:#353F7D;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:FS Neruda;--chakra-fonts-body:FS Meridian Regular,sans-serif;--chakra-fonts-mono:FS Hack;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1syi0wy">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 1baqkrf">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-gray-800);background:var(--chakra-colors-white);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}</style><style data-emotion="css mfxtb">.css-mfxtb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;box-shadow:var(--chakra-shadows-base);width:100%;margin-bottom:var(--chakra-space-8);padding:var(--chakra-space-8);}</style><header class="css-mfxtb"><style data-emotion="css 18ci58h">.css-18ci58h{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;max-width:var(--chakra-sizes-8xl);width:100%;margin:auto;}</style><div class="css-18ci58h"><div class="css-0"><a href="/"><img alt="Logo" src="https://media.made.com/mws-assets/images/MadeLogo.2.svg" class="chakra-image css-0" aria-label="Logo"/></a></div><style data-emotion="css 1wsmmqi">@media screen and (min-width: 30em){.css-1wsmmqi{display:block;}}@media screen and (min-width: 48em){.css-1wsmmqi{display:none;}}</style><div class="css-1wsmmqi"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div><style data-emotion="css 3txhs">.css-3txhs{display:none;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;margin-left:auto;}@media screen and (min-width: 48em){.css-3txhs{display:block;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;}}</style><div class="css-3txhs"><style data-emotion="css 1lpw2d">.css-1lpw2d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:var(--chakra-space-8);-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}@media screen and (min-width: 30em){.css-1lpw2d{-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 48em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 62em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}</style><div class="chakra-stack css-1lpw2d"><style data-emotion="css f4h6uy">.css-f4h6uy{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;}.css-f4h6uy:hover,.css-f4h6uy[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-f4h6uy:focus,.css-f4h6uy[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a target="" class="chakra-link css-f4h6uy" href="/"><style data-emotion="css 1twuvi0">.css-1twuvi0{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;width:100%;}.css-1twuvi0>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0.5rem;margin-inline-start:0.5rem;}</style><div class="chakra-stack css-1twuvi0"><p class="chakra-text css-0">Home</p></div></a><a target="_blank" class="chakra-link css-f4h6uy" href="https://www.made.com/careers"><div class="chakra-stack css-1twuvi0"><p class="chakra-text css-0">Careers</p><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></div></a></div></div></div></header><style data-emotion="css rkbxzj">.css-rkbxzj{width:100%;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;max-width:var(--chakra-sizes-4xl);-webkit-padding-start:1rem;padding-inline-start:1rem;-webkit-padding-end:1rem;padding-inline-end:1rem;}</style><div class="chakra-container css-rkbxzj"><style data-emotion="css 1xr7jem">.css-1xr7jem{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-5xl);line-height:1;margin-bottom:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-1xr7jem{font-size:var(--chakra-fontSizes-6xl);}}</style><h1 class="chakra-heading css-1xr7jem">Repositoriy and unit of work pattern in python</h1><style data-emotion="css 1iv087f">.css-1iv087f{margin-bottom:var(--chakra-space-2);font-weight:var(--chakra-fontWeights-bold);}</style><p class="chakra-text css-1iv087f">by <!-- -->Bob</p><style data-emotion="css b64cj9">.css-b64cj9{margin-bottom:var(--chakra-space-4);color:var(--chakra-colors-made-50);}</style><p class="chakra-text css-b64cj9">Fri Sep 08 2017</p><style data-emotion="css rszk63">.css-rszk63{margin-bottom:var(--chakra-space-4);}</style><p class="chakra-text css-rszk63">In the
<style data-emotion="css 1ud5qxa">.css-1ud5qxa{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:var(--chakra-colors-made-blue);}.css-1ud5qxa:hover,.css-1ud5qxa[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-1ud5qxa:focus,.css-1ud5qxa[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a target="_blank" class="chakra-link css-1ud5qxa" href="http://io.made.com/blog/2017-09-07-introducing-command-handler.html">previous part</a> of
this series we built a toy system that could add a new Issue to an IssueLog, but had no
real behaviour of its own, and would lose its data every time the application restarted.
We&#x27;re going to extend it a little by introducing some patterns for persistent data
access, and talk a little more about the ideas underlying ports and adapters
architectures. To recap, we&#x27;re abiding by three principles:</p><ol><li>Clearly define the boundaries of our use cases.</li><li>Depend on abstractions, not on concrete implementation.</li><li>Identify glue code as distinct from domain logic and put it into its own layer.</li></ol><p class="chakra-text css-rszk63">In our command handler, we wrote the following code:</p><pre><style data-emotion="css 77j1of">.css-77j1of{background:var(--chakra-colors-orange-50);border-radius:10px;margin-bottom:var(--chakra-space-10);font-size:var(--chakra-fontSizes-sm);box-shadow:var(--chakra-shadows-lg);}</style><div class="chakra-wrap css-77j1of"><style data-emotion="css umyqv7">.css-umyqv7{--chakra-wrap-spacing:0.5rem;--wrap-spacing:calc(var(--chakra-wrap-spacing) / 2);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;list-style-type:none;padding:0px;margin:calc(var(--wrap-spacing) * -1);}.css-umyqv7>*:not(style){margin:var(--wrap-spacing);}</style><ul class="chakra-wrap__list css-umyqv7"><style data-emotion="css r4358i">.css-r4358i{padding:var(--chakra-space-5);}</style><div class="css-r4358i">reporter = IssueReporter(cmd.reporter_name, cmd.reporter_email)
issue = Issue(reporter, cmd.problem_description)
issue_log.add(issue)
</div></ul></div></pre><p class="chakra-text css-rszk63">The IssueLog is a term from our conversation with the domain expert. It&#x27;s the place that
they record the list of all issues. This is part of the jargon used by our customers,
and so it clearly belongs in the domain, but it&#x27;s also the ideal abstraction for a data
store. How can we modify the code so that our newly created Issue will be persisted? We
don&#x27;t want our IssueLog to depend on the database, because that&#x27;s a violation of
principle #2. This is the question that leads us to the ports &amp; adapters architecture.</p><p class="chakra-text css-rszk63">In a ports and adapters architecture, we build a pure domain that exposes ports. A port
is a way for data to get into, or out of, the domain model. In this system, the IssueLog
is a port. Ports are connected to the external world by Adapters. In the previous code
sample, the FakeIssueLog is an adapter: it provides a service to the system by
implementing an interface.</p><p class="chakra-text css-rszk63">Let&#x27;s use a real-world analogy. Imagine we have a circuit that detects current over some
threshold. If the threshold is reached, the circuit outputs a signal. Into our circuit
we attach two ports, one for current in, and one for current out. The input and output
channels are part of our circuit: without them, the circuit is useless.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class ThresholdDetectionCircuit:

    arbitrary_threshold = 4

    def __init__(self, input: ReadablePort, output: WriteablePort):
        self.input = input
        self.output = output

    def read_from_input(self):
        next_value = self.input.read()
        if next_value &gt; self.arbitrary_threshold:
            self.output.write(1)
</div></ul></div></pre><p class="chakra-text css-rszk63">Because we had the great foresight to use standardised ports, we can plug any number of
different devices into our circuit. For example, we could attach a light-detector to the
input and a buzzer to the output, or we could attach a dial to the input, and a light to
the output, and so on.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class LightDetector(ReadablePort):
    def read(self):
        return self.get_light_amplitude()

class Buzzer(WriteablePort):
    def write(self, value):
        if value &gt; 0:
            self.make_infuriating_noise()


class Dial(ReadablePort):
    def read(self):
        return self.current_value

class Light(WriteablePort):
    def write(self, value):
        if value &gt; 0:
            self.on = True
        else:
            self.on = False
</div></ul></div></pre><p class="chakra-text css-rszk63">Considered in isolation, this is just an example of good OO practice: we are extending
our system through <strong>composition</strong>. What makes this a ports-and-adapters architecture is
the idea that there is an internal world consisting of the domain model (our
ThresholdDetectionCircuit), and an external world that drives the domain model through
well-defined ports. How does all of this relate to databases?</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">from SqlAlchemy import Session

class SqlAlchemyIssueLog (IssueLog):

    def __init__(self, session: Session):
        self.session = session

    def add(self, issue):
        self.session.add(issue)


class TextFileIssueLog (IssueLog):

    def __init__(self, path):
        self.path = path

    def add(self, issue):
        with open(self.path, &#x27;w&#x27;) as f:
            json.dump(f)
</div></ul></div></pre><p class="chakra-text css-rszk63">By analogy to our circuit example, the IssueLog is a WriteablePort - it&#x27;s a way for us
to get data out of the system. SqlAlchemy and the file system are two types of adapter
that we can plug in, just like the Buzzer or Light classes. In fact, the IssueLog is an
instance of a common design pattern: it&#x27;s a
<a target="_blank" class="chakra-link css-1ud5qxa" href="https://martinfowler.com/eaaCatalog/repository.html">Repository</a>. A repository is an
object that hides the details of persistent storage by presenting us with an interface
that looks like a collection. We should be able to add new things to the repository, and
get things out of the repository, and that&#x27;s essentially it.</p><p class="chakra-text css-rszk63">Let&#x27;s look at a simple repository pattern.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class FooRepository:
    def __init__(self, db_session):
        self.session = db_session

    def add_new_item(self, item):
        self.db_session.add(item)

    def get_item(self, id):
        return self.db_session.get(Foo, id)

    def find_foos_by_latitude(self, latitude):
        return self.session.query(Foo).\
                filter(foo.latitude == latitude)
</div></ul></div></pre><p class="chakra-text css-rszk63">We expose a few methods, one to add new items, one to get items by their id, and a third
to find items by some criterion. This FooRepository is using a
<a target="_blank" class="chakra-link css-1ud5qxa" href="http://docs.sqlalchemy.org/en/latest/orm/session_basics.html">SqlAlchemy session</a>
object, so it&#x27;s part of our Adapter layer. We could define a different adapter for use
in unit tests.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class FooRepository:
    def __init__(self, db_session):
        self.items = []

    def add_new_item(self, item):
        self.items.append(item)

    def get_item(self, id):
        return next((item for item in self.items
                          if item.id == id))

    def find_foos_by_latitude(self, latitude):
        return (item for item in self.items
                     if item.latitude == latitude)
</div></ul></div></pre><p class="chakra-text css-rszk63">This adapter works just the same as the one backed by a real database, but does so
without any external state. This allows us to test our code without resorting to
Setup/Teardown scripts on our database, or monkey patching our ORM to return hard-coded
values. We just plug a different adapter into the existing port. As with the
ReadablePort and WriteablePort, the simplicity of this interface makes it simple for us
to plug in different implementations.</p><p class="chakra-text css-rszk63">The repository gives us read/write access to objects in our data store, and is commonly
used with another pattern, the
<a target="_blank" class="chakra-link css-1ud5qxa" href="https://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a>. A unit of work
represents a bunch of things that all have to happen together. It usually allows us to
cache objects in memory for the lifetime of a request so that we don&#x27;t need to make
repeated calls to the database. A unit of work is responsible for doing dirty checks on
our objects, and flushing any changes to state at the end of a request.</p><p class="chakra-text css-rszk63">What does a unit of work look like?</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class SqlAlchemyUnitOfWorkManager(UnitOfWorkManager):
    &quot;&quot;&quot;The Unit of work manager returns a new unit of work.
       Our UOW is backed by a sql alchemy session whose
       lifetime can be scoped to a web request, or a
       long-lived background job.&quot;&quot;&quot;
    def __init__(self, session_maker):
        self.session_maker = session_maker

    def start(self):
        return SqlAlchemyUnitOfWork(self.session_maker)


class SqlAlchemyUnitOfWork(UnitOfWork):
    &quot;&quot;&quot;The unit of work captures the idea of a set of things that
       need to happen together.

       Usually, in a relational database,
       one unit of work == one database transaction.&quot;&quot;&quot;

    def __init__(self, sessionfactory):
        self.sessionfactory = sessionfactory

    def __enter__(self):
        self.session = self.sessionfactory()
        return self

    def __exit__(self, type, value, traceback):
        self.session.close()

    def commit(self):
        self.session.commit()

    def rollback(self):
        self.session.rollback()

    # I tend to put my repositories onto my UOW
    # for convenient access.
    @property
    def issues(self):
        return IssueRepository(self.session)
</div></ul></div></pre><p class="chakra-text css-rszk63">This code is taken from a current production system - the code to implement these
patterns really isn&#x27;t complex. The only thing missing here is some logging and error
handling in the commit method. Our unit-of-work manager creates a new unit-of-work, or
gives us an existing one depending on how we&#x27;ve configured SqlAlchemy. The unit of work
itself is just a thin layer over the top of SqlAlchemy that gives us explicit rollback
and commit points. Let&#x27;s revisit our first command handler and see how we might use
these patterns together.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class ReportIssueHandler:
    def __init__(self, uowm:UnitOfWorkManager):
        self.uowm = uowm

    def handle(self, cmd):
        with self.uowm.start() as unit_of_work:
            reporter = IssueReporter(cmd.reporter_name, cmd.reporter_email)
            issue = Issue(reporter, cmd.problem_description)
            unit_of_work.issues.add(issue)
            unit_of_work.commit()
</div></ul></div></pre><p class="chakra-text css-rszk63">Our command handler looks more or less the same, except that it&#x27;s now responsible for
starting a unit-of-work, and committing the unit-of-work when it has finished. This is
in keeping with our rule #1 - we will clearly define the beginning and end of use cases.
We know for a fact that only one object is being loaded and modified here, and our
database transaction is kept short. Our handler depends on an abstraction - the
UnitOfWorkManager, and doesn&#x27;t care if that&#x27;s a test-double or a SqlAlchemy session, so
that&#x27;s rule #2 covered. Lastly, this code is painfully boring because it&#x27;s just glue.
We&#x27;re moving all the dull glue out to the edges of our system so that we can write our
domain model in any way that we like: rule #3 observed.</p><p class="chakra-text css-rszk63"><a target="_blank" class="chakra-link css-1ud5qxa" href="https://github.com/bobthemighty/blog-code-samples/tree/master/ports-and-adapters/02">The code sample for this part</a>
adds a couple of new packages -
<a target="_blank" class="chakra-link css-1ud5qxa" href="http://pycon-2012-notes.readthedocs.io/en/latest/fast_tests_slow_tests.html">one for slow tests</a>
(tests that go over a network, or to a real file system), and one for our adapters. We
haven&#x27;t added any new features yet, but we&#x27;ve added a test that shows we can insert an
Issue into a sqlite database through our command handler and unit of work. Notice that
all of the ORM code is in one module (issues.adapters.orm) and that it depends on our
domain model, not the other way around. Our domain objects don&#x27;t inherit from
SqlAlchemy&#x27;s declarative base. We&#x27;re beginning to get some sense of what it means to
have the domain on the &quot;inside&quot; of a system, and the infrastructural code on the
outside.</p><p class="chakra-text css-rszk63">Our unit test has been updated to use a unit of work, and we can now test that we insert
an issue into our issue log, and commit the unit of work, without having a dependency on
any actual implementation details. We could completely delete SqlAlchemy from our code
base, and our unit tests would continue to work, because we have a pure domain model and
we expose abstract ports from our service layer.</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">class When_reporting_an_issue:

    def given_an_empty_unit_of_work(self):
        self.uow = FakeUnitOfWork()

    def because_we_report_a_new_issue(self):
        handler = ReportIssueHandler(self.uow)
        cmd = ReportIssueCommand(name, email, desc)

        handler.handle(cmd)

    def the_handler_should_have_created_a_new_issue(self):
        expect(self.uow.issues).to(have_len(1))

    def it_should_have_recorded_the_issue(self):
        expect(self.uow.issues[0].reporter.name).to(equal(name))
        expect(self.uow.issues[0].reporter.email).to(equal(email))

    def it_should_have_recorded_the_description(self):
        expect(self.uow.issues[0].description).to(equal(desc))

    def it_should_have_committed_the_unit_of_work(self):
        expect(self.uow.was_committed).to(be_true)
</div></ul></div></pre><p class="chakra-text css-rszk63"><a target="_blank" class="chakra-link css-1ud5qxa" href="http://io.made.com/blog/2017-09-13-commands-and-queries-handlers-and-views.html">Next time</a>
we&#x27;ll look at how to get data back out of the system.</p></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var h=Object.defineProperty,p=Object.defineProperties;var c=Object.getOwnPropertyDescriptors;var r=Object.getOwnPropertySymbols;var i=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable;var l=(e,s,o)=\u003es in e?h(e,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[s]=o,t=(e,s)=\u003e{for(var o in s||(s={}))i.call(s,o)\u0026\u0026l(e,o,s[o]);if(r)for(var o of r(s))n.call(s,o)\u0026\u0026l(e,o,s[o]);return e},d=(e,s)=\u003ep(e,c(s));var u=(e,s)=\u003e{var o={};for(var a in e)i.call(e,a)\u0026\u0026s.indexOf(a)\u003c0\u0026\u0026(o[a]=e[a]);if(e!=null\u0026\u0026r)for(var a of r(e))s.indexOf(a)\u003c0\u0026\u0026n.call(e,a)\u0026\u0026(o[a]=e[a]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var a=o,{components:e}=a,s=u(a,[\"components\"]);return mdx(MDXLayout,d(t(t({},layoutProps),s),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`In the\n`,mdx(\"a\",t({parentName:\"p\"},{href:\"http://io.made.com/blog/2017-09-07-introducing-command-handler.html\"}),\"previous part\"),` of\nthis series we built a toy system that could add a new Issue to an IssueLog, but had no\nreal behaviour of its own, and would lose its data every time the application restarted.\nWe're going to extend it a little by introducing some patterns for persistent data\naccess, and talk a little more about the ideas underlying ports and adapters\narchitectures. To recap, we're abiding by three principles:`),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},\"Clearly define the boundaries of our use cases.\"),mdx(\"li\",{parentName:\"ol\"},\"Depend on abstractions, not on concrete implementation.\"),mdx(\"li\",{parentName:\"ol\"},\"Identify glue code as distinct from domain logic and put it into its own layer.\")),mdx(\"p\",null,\"In our command handler, we wrote the following code:\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`reporter = IssueReporter(cmd.reporter_name, cmd.reporter_email)\nissue = Issue(reporter, cmd.problem_description)\nissue_log.add(issue)\n`)),mdx(\"p\",null,`The IssueLog is a term from our conversation with the domain expert. It's the place that\nthey record the list of all issues. This is part of the jargon used by our customers,\nand so it clearly belongs in the domain, but it's also the ideal abstraction for a data\nstore. How can we modify the code so that our newly created Issue will be persisted? We\ndon't want our IssueLog to depend on the database, because that's a violation of\nprinciple #2. This is the question that leads us to the ports \u0026 adapters architecture.`),mdx(\"p\",null,`In a ports and adapters architecture, we build a pure domain that exposes ports. A port\nis a way for data to get into, or out of, the domain model. In this system, the IssueLog\nis a port. Ports are connected to the external world by Adapters. In the previous code\nsample, the FakeIssueLog is an adapter: it provides a service to the system by\nimplementing an interface.`),mdx(\"p\",null,`Let's use a real-world analogy. Imagine we have a circuit that detects current over some\nthreshold. If the threshold is reached, the circuit outputs a signal. Into our circuit\nwe attach two ports, one for current in, and one for current out. The input and output\nchannels are part of our circuit: without them, the circuit is useless.`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class ThresholdDetectionCircuit:\n\n    arbitrary_threshold = 4\n\n    def __init__(self, input: ReadablePort, output: WriteablePort):\n        self.input = input\n        self.output = output\n\n    def read_from_input(self):\n        next_value = self.input.read()\n        if next_value \u003e self.arbitrary_threshold:\n            self.output.write(1)\n`)),mdx(\"p\",null,`Because we had the great foresight to use standardised ports, we can plug any number of\ndifferent devices into our circuit. For example, we could attach a light-detector to the\ninput and a buzzer to the output, or we could attach a dial to the input, and a light to\nthe output, and so on.`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class LightDetector(ReadablePort):\n    def read(self):\n        return self.get_light_amplitude()\n\nclass Buzzer(WriteablePort):\n    def write(self, value):\n        if value \u003e 0:\n            self.make_infuriating_noise()\n\n\nclass Dial(ReadablePort):\n    def read(self):\n        return self.current_value\n\nclass Light(WriteablePort):\n    def write(self, value):\n        if value \u003e 0:\n            self.on = True\n        else:\n            self.on = False\n`)),mdx(\"p\",null,`Considered in isolation, this is just an example of good OO practice: we are extending\nour system through `,mdx(\"strong\",{parentName:\"p\"},\"composition\"),`. What makes this a ports-and-adapters architecture is\nthe idea that there is an internal world consisting of the domain model (our\nThresholdDetectionCircuit), and an external world that drives the domain model through\nwell-defined ports. How does all of this relate to databases?`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`from SqlAlchemy import Session\n\nclass SqlAlchemyIssueLog (IssueLog):\n\n    def __init__(self, session: Session):\n        self.session = session\n\n    def add(self, issue):\n        self.session.add(issue)\n\n\nclass TextFileIssueLog (IssueLog):\n\n    def __init__(self, path):\n        self.path = path\n\n    def add(self, issue):\n        with open(self.path, 'w') as f:\n            json.dump(f)\n`)),mdx(\"p\",null,`By analogy to our circuit example, the IssueLog is a WriteablePort - it's a way for us\nto get data out of the system. SqlAlchemy and the file system are two types of adapter\nthat we can plug in, just like the Buzzer or Light classes. In fact, the IssueLog is an\ninstance of a common design pattern: it's a\n`,mdx(\"a\",t({parentName:\"p\"},{href:\"https://martinfowler.com/eaaCatalog/repository.html\"}),\"Repository\"),`. A repository is an\nobject that hides the details of persistent storage by presenting us with an interface\nthat looks like a collection. We should be able to add new things to the repository, and\nget things out of the repository, and that's essentially it.`),mdx(\"p\",null,\"Let's look at a simple repository pattern.\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class FooRepository:\n    def __init__(self, db_session):\n        self.session = db_session\n\n    def add_new_item(self, item):\n        self.db_session.add(item)\n\n    def get_item(self, id):\n        return self.db_session.get(Foo, id)\n\n    def find_foos_by_latitude(self, latitude):\n        return self.session.query(Foo).\\\\\n                filter(foo.latitude == latitude)\n`)),mdx(\"p\",null,`We expose a few methods, one to add new items, one to get items by their id, and a third\nto find items by some criterion. This FooRepository is using a\n`,mdx(\"a\",t({parentName:\"p\"},{href:\"http://docs.sqlalchemy.org/en/latest/orm/session_basics.html\"}),\"SqlAlchemy session\"),`\nobject, so it's part of our Adapter layer. We could define a different adapter for use\nin unit tests.`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class FooRepository:\n    def __init__(self, db_session):\n        self.items = []\n\n    def add_new_item(self, item):\n        self.items.append(item)\n\n    def get_item(self, id):\n        return next((item for item in self.items\n                          if item.id == id))\n\n    def find_foos_by_latitude(self, latitude):\n        return (item for item in self.items\n                     if item.latitude == latitude)\n`)),mdx(\"p\",null,`This adapter works just the same as the one backed by a real database, but does so\nwithout any external state. This allows us to test our code without resorting to\nSetup/Teardown scripts on our database, or monkey patching our ORM to return hard-coded\nvalues. We just plug a different adapter into the existing port. As with the\nReadablePort and WriteablePort, the simplicity of this interface makes it simple for us\nto plug in different implementations.`),mdx(\"p\",null,`The repository gives us read/write access to objects in our data store, and is commonly\nused with another pattern, the\n`,mdx(\"a\",t({parentName:\"p\"},{href:\"https://martinfowler.com/eaaCatalog/unitOfWork.html\"}),\"Unit of Work\"),`. A unit of work\nrepresents a bunch of things that all have to happen together. It usually allows us to\ncache objects in memory for the lifetime of a request so that we don't need to make\nrepeated calls to the database. A unit of work is responsible for doing dirty checks on\nour objects, and flushing any changes to state at the end of a request.`),mdx(\"p\",null,\"What does a unit of work look like?\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class SqlAlchemyUnitOfWorkManager(UnitOfWorkManager):\n    \"\"\"The Unit of work manager returns a new unit of work.\n       Our UOW is backed by a sql alchemy session whose\n       lifetime can be scoped to a web request, or a\n       long-lived background job.\"\"\"\n    def __init__(self, session_maker):\n        self.session_maker = session_maker\n\n    def start(self):\n        return SqlAlchemyUnitOfWork(self.session_maker)\n\n\nclass SqlAlchemyUnitOfWork(UnitOfWork):\n    \"\"\"The unit of work captures the idea of a set of things that\n       need to happen together.\n\n       Usually, in a relational database,\n       one unit of work == one database transaction.\"\"\"\n\n    def __init__(self, sessionfactory):\n        self.sessionfactory = sessionfactory\n\n    def __enter__(self):\n        self.session = self.sessionfactory()\n        return self\n\n    def __exit__(self, type, value, traceback):\n        self.session.close()\n\n    def commit(self):\n        self.session.commit()\n\n    def rollback(self):\n        self.session.rollback()\n\n    # I tend to put my repositories onto my UOW\n    # for convenient access.\n    @property\n    def issues(self):\n        return IssueRepository(self.session)\n`)),mdx(\"p\",null,`This code is taken from a current production system - the code to implement these\npatterns really isn't complex. The only thing missing here is some logging and error\nhandling in the commit method. Our unit-of-work manager creates a new unit-of-work, or\ngives us an existing one depending on how we've configured SqlAlchemy. The unit of work\nitself is just a thin layer over the top of SqlAlchemy that gives us explicit rollback\nand commit points. Let's revisit our first command handler and see how we might use\nthese patterns together.`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class ReportIssueHandler:\n    def __init__(self, uowm:UnitOfWorkManager):\n        self.uowm = uowm\n\n    def handle(self, cmd):\n        with self.uowm.start() as unit_of_work:\n            reporter = IssueReporter(cmd.reporter_name, cmd.reporter_email)\n            issue = Issue(reporter, cmd.problem_description)\n            unit_of_work.issues.add(issue)\n            unit_of_work.commit()\n`)),mdx(\"p\",null,`Our command handler looks more or less the same, except that it's now responsible for\nstarting a unit-of-work, and committing the unit-of-work when it has finished. This is\nin keeping with our rule #1 - we will clearly define the beginning and end of use cases.\nWe know for a fact that only one object is being loaded and modified here, and our\ndatabase transaction is kept short. Our handler depends on an abstraction - the\nUnitOfWorkManager, and doesn't care if that's a test-double or a SqlAlchemy session, so\nthat's rule #2 covered. Lastly, this code is painfully boring because it's just glue.\nWe're moving all the dull glue out to the edges of our system so that we can write our\ndomain model in any way that we like: rule #3 observed.`),mdx(\"p\",null,mdx(\"a\",t({parentName:\"p\"},{href:\"https://github.com/bobthemighty/blog-code-samples/tree/master/ports-and-adapters/02\"}),\"The code sample for this part\"),`\nadds a couple of new packages -\n`,mdx(\"a\",t({parentName:\"p\"},{href:\"http://pycon-2012-notes.readthedocs.io/en/latest/fast_tests_slow_tests.html\"}),\"one for slow tests\"),`\n(tests that go over a network, or to a real file system), and one for our adapters. We\nhaven't added any new features yet, but we've added a test that shows we can insert an\nIssue into a sqlite database through our command handler and unit of work. Notice that\nall of the ORM code is in one module (issues.adapters.orm) and that it depends on our\ndomain model, not the other way around. Our domain objects don't inherit from\nSqlAlchemy's declarative base. We're beginning to get some sense of what it means to\nhave the domain on the \"inside\" of a system, and the infrastructural code on the\noutside.`),mdx(\"p\",null,`Our unit test has been updated to use a unit of work, and we can now test that we insert\nan issue into our issue log, and commit the unit of work, without having a dependency on\nany actual implementation details. We could completely delete SqlAlchemy from our code\nbase, and our unit tests would continue to work, because we have a pure domain model and\nwe expose abstract ports from our service layer.`),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python\"}),`class When_reporting_an_issue:\n\n    def given_an_empty_unit_of_work(self):\n        self.uow = FakeUnitOfWork()\n\n    def because_we_report_a_new_issue(self):\n        handler = ReportIssueHandler(self.uow)\n        cmd = ReportIssueCommand(name, email, desc)\n\n        handler.handle(cmd)\n\n    def the_handler_should_have_created_a_new_issue(self):\n        expect(self.uow.issues).to(have_len(1))\n\n    def it_should_have_recorded_the_issue(self):\n        expect(self.uow.issues[0].reporter.name).to(equal(name))\n        expect(self.uow.issues[0].reporter.email).to(equal(email))\n\n    def it_should_have_recorded_the_description(self):\n        expect(self.uow.issues[0].description).to(equal(desc))\n\n    def it_should_have_committed_the_unit_of_work(self):\n        expect(self.uow.was_committed).to(be_true)\n`)),mdx(\"p\",null,mdx(\"a\",t({parentName:\"p\"},{href:\"http://io.made.com/blog/2017-09-13-commands-and-queries-handlers-and-views.html\"}),\"Next time\"),`\nwe'll look at how to get data back out of the system.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"date":"2017-09-08","title":"Repositoriy and unit of work pattern in python","layout":"post","author":"Bob","categories":["ports \u0026 adapters"],"tags":["python","architecture"]},"__N_SSG":true},"page":"/[slug]","query":{"slug":"2017-09-08-repository-and-unit-of-work-pattern-in-python"},"buildId":"hH0eCY_oB5qaF9gyvL6n1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>