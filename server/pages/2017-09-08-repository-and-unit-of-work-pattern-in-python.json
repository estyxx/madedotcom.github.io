{"pageProps":{"source":{"compiledSource":"var u=Object.defineProperty,d=Object.defineProperties;var i=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var p=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable;var m=(e,n,s)=>n in e?u(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s,a=(e,n)=>{for(var s in n||(n={}))p.call(n,s)&&m(e,s,n[s]);if(o)for(var s of o(n))c.call(n,s)&&m(e,s,n[s]);return e},r=(e,n)=>d(e,i(n));var N=(e,n)=>{var s={};for(var t in e)p.call(e,t)&&n.indexOf(t)<0&&(s[t]=e[t]);if(e!=null&&o)for(var t of o(e))n.indexOf(t)<0&&c.call(e,t)&&(s[t]=e[t]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var t=s,{components:e}=t,n=N(t,[\"components\"]);return mdx(MDXLayout,r(a(a({},layoutProps),n),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`In the\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"http://io.made.com/blog/2017-09-07-introducing-command-handler.html\"}),\"previous part\"),` of\nthis series we built a toy system that could add a new Issue to an IssueLog, but had no\nreal behaviour of its own, and would lose its data every time the application restarted.\nWe're going to extend it a little by introducing some patterns for persistent data\naccess, and talk a little more about the ideas underlying ports and adapters\narchitectures. To recap, we're abiding by three principles:`),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},\"Clearly define the boundaries of our use cases.\"),mdx(\"li\",{parentName:\"ol\"},\"Depend on abstractions, not on concrete implementation.\"),mdx(\"li\",{parentName:\"ol\"},\"Identify glue code as distinct from domain logic and put it into its own layer.\")),mdx(\"p\",null,\"In our command handler, we wrote the following code:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),\"reporter \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" IssueReporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter_name\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter_email\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\nissue `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" Issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"reporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"problem_description\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\nissue_log`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"add\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`The IssueLog is a term from our conversation with the domain expert. It's the place that\nthey record the list of all issues. This is part of the jargon used by our customers,\nand so it clearly belongs in the domain, but it's also the ideal abstraction for a data\nstore. How can we modify the code so that our newly created Issue will be persisted? We\ndon't want our IssueLog to depend on the database, because that's a violation of\nprinciple #2. This is the question that leads us to the ports & adapters architecture.`),mdx(\"p\",null,`In a ports and adapters architecture, we build a pure domain that exposes ports. A port\nis a way for data to get into, or out of, the domain model. In this system, the IssueLog\nis a port. Ports are connected to the external world by Adapters. In the previous code\nsample, the FakeIssueLog is an adapter: it provides a service to the system by\nimplementing an interface.`),mdx(\"p\",null,`Let's use a real-world analogy. Imagine we have a circuit that detects current over some\nthreshold. If the threshold is reached, the circuit outputs a signal. Into our circuit\nwe attach two ports, one for current in, and one for current out. The input and output\nchannels are part of our circuit: without them, the circuit is useless.`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"ThresholdDetectionCircuit\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n\n    arbitrary_threshold `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"4\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"input\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" ReadablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" output\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" WriteablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"input\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"input\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"output \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` output\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"read_from_input\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        next_value `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"input\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"read\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" next_value \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\">\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"arbitrary_threshold\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"output\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"write\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`Because we had the great foresight to use standardised ports, we can plug any number of\ndifferent devices into our circuit. For example, we could attach a light-detector to the\ninput and a buzzer to the output, or we could attach a dial to the input, and a light to\nthe output, and so on.`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"LightDetector\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ReadablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"read\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"get_light_amplitude\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Buzzer\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"WriteablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"write\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" value \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\">\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"make_infuriating_noise\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Dial\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ReadablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"read\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),`current_value\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Light\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"WriteablePort\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"write\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" value \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\">\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"on \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"True\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"else\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"on \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"False\"),`\n`))),mdx(\"p\",null,`Considered in isolation, this is just an example of good OO practice: we are extending\nour system through `,mdx(\"strong\",{parentName:\"p\"},\"composition\"),`. What makes this a ports-and-adapters architecture is\nthe idea that there is an internal world consisting of the domain model (our\nThresholdDetectionCircuit), and an external world that drives the domain model through\nwell-defined ports. How does all of this relate to databases?`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" SqlAlchemy \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),` Session\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"SqlAlchemyIssueLog\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"IssueLog\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\" Session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` session\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"add\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"add\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"TextFileIssueLog\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"IssueLog\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" path\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` path\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"add\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"with\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"open\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"path\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'w'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"as\"),\" f\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            json`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"dump\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"f\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`By analogy to our circuit example, the IssueLog is a WriteablePort - it's a way for us\nto get data out of the system. SqlAlchemy and the file system are two types of adapter\nthat we can plug in, just like the Buzzer or Light classes. In fact, the IssueLog is an\ninstance of a common design pattern: it's a\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"https://martinfowler.com/eaaCatalog/repository.html\"}),\"Repository\"),`. A repository is an\nobject that hides the details of persistent storage by presenting us with an interface\nthat looks like a collection. We should be able to add new things to the repository, and\nget things out of the repository, and that's essentially it.`),mdx(\"p\",null,\"Let's look at a simple repository pattern.\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"FooRepository\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" db_session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` db_session\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"add_new_item\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"db_session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"add\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get_item\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"id\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"db_session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"get\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"Foo\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"id\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"find_foos_by_latitude\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" latitude\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"query\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"Foo\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),`\\\\\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"filter\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"foo\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"latitude \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"==\"),\" latitude\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`We expose a few methods, one to add new items, one to get items by their id, and a third\nto find items by some criterion. This FooRepository is using a\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"http://docs.sqlalchemy.org/en/latest/orm/session_basics.html\"}),\"SqlAlchemy session\"),`\nobject, so it's part of our Adapter layer. We could define a different adapter for use\nin unit tests.`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"FooRepository\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" db_session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"items \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"add_new_item\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"items\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"append\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get_item\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"id\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"next\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"item \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"for\"),\" item \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"in\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),`items\n                          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"id\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"==\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"id\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"find_foos_by_latitude\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" latitude\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"item \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"for\"),\" item \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"in\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),`items\n                     `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" item\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"latitude \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"==\"),\" latitude\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`This adapter works just the same as the one backed by a real database, but does so\nwithout any external state. This allows us to test our code without resorting to\nSetup/Teardown scripts on our database, or monkey patching our ORM to return hard-coded\nvalues. We just plug a different adapter into the existing port. As with the\nReadablePort and WriteablePort, the simplicity of this interface makes it simple for us\nto plug in different implementations.`),mdx(\"p\",null,`The repository gives us read/write access to objects in our data store, and is commonly\nused with another pattern, the\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"https://martinfowler.com/eaaCatalog/unitOfWork.html\"}),\"Unit of Work\"),`. A unit of work\nrepresents a bunch of things that all have to happen together. It usually allows us to\ncache objects in memory for the lifetime of a request so that we don't need to make\nrepeated calls to the database. A unit of work is responsible for doing dirty checks on\nour objects, and flushing any changes to state at the end of a request.`),mdx(\"p\",null,\"What does a unit of work look like?\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"SqlAlchemyUnitOfWorkManager\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"UnitOfWorkManager\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),'\"\"\"The Unit of work manager returns a new unit of work.'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),\"       Our UOW is backed by a sql alchemy session whose\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),\"       lifetime can be scoped to a web request, or a\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),'       long-lived background job.\"\"\"'),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" session_maker\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session_maker \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` session_maker\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"start\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" SqlAlchemyUnitOfWork\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session_maker\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"SqlAlchemyUnitOfWork\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"UnitOfWork\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),'\"\"\"The unit of work captures the idea of a set of things that'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),\"       need to happen together.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"})),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),\"       Usually, in a relational database,\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token triple-quoted-string string\"}),'       one unit of work == one database transaction.\"\"\"'),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" sessionfactory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"sessionfactory \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` sessionfactory\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__enter__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"sessionfactory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),` self\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__exit__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"type\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" traceback\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"close\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"commit\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"commit\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"rollback\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"rollback\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# I tend to put my repositories onto my UOW\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# for convenient access.\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token decorator annotation punctuation\"}),\"@property\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"issues\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" IssueRepository\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`This code is taken from a current production system - the code to implement these\npatterns really isn't complex. The only thing missing here is some logging and error\nhandling in the commit method. Our unit-of-work manager creates a new unit-of-work, or\ngives us an existing one depending on how we've configured SqlAlchemy. The unit of work\nitself is just a thin layer over the top of SqlAlchemy that gives us explicit rollback\nand commit points. Let's revisit our first command handler and see how we might use\nthese patterns together.`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"ReportIssueHandler\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"__init__\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" uowm\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),\"UnitOfWorkManager\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uowm \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` uowm\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"handle\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"with\"),\" self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uowm\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"start\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"as\"),\" unit_of_work\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n            reporter `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" IssueReporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter_name\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter_email\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n            issue `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" Issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"reporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"problem_description\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n            unit_of_work`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"issues\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"add\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"issue\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n            unit_of_work`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"commit\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,`Our command handler looks more or less the same, except that it's now responsible for\nstarting a unit-of-work, and committing the unit-of-work when it has finished. This is\nin keeping with our rule #1 - we will clearly define the beginning and end of use cases.\nWe know for a fact that only one object is being loaded and modified here, and our\ndatabase transaction is kept short. Our handler depends on an abstraction - the\nUnitOfWorkManager, and doesn't care if that's a test-double or a SqlAlchemy session, so\nthat's rule #2 covered. Lastly, this code is painfully boring because it's just glue.\nWe're moving all the dull glue out to the edges of our system so that we can write our\ndomain model in any way that we like: rule #3 observed.`),mdx(\"p\",null,mdx(\"a\",a({parentName:\"p\"},{href:\"https://github.com/bobthemighty/blog-code-samples/tree/master/ports-and-adapters/02\"}),\"The code sample for this part\"),`\nadds a couple of new packages -\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"http://pycon-2012-notes.readthedocs.io/en/latest/fast_tests_slow_tests.html\"}),\"one for slow tests\"),`\n(tests that go over a network, or to a real file system), and one for our adapters. We\nhaven't added any new features yet, but we've added a test that shows we can insert an\nIssue into a sqlite database through our command handler and unit of work. Notice that\nall of the ORM code is in one module (issues.adapters.orm) and that it depends on our\ndomain model, not the other way around. Our domain objects don't inherit from\nSqlAlchemy's declarative base. We're beginning to get some sense of what it means to\nhave the domain on the \"inside\" of a system, and the infrastructural code on the\noutside.`),mdx(\"p\",null,`Our unit test has been updated to use a unit of work, and we can now test that we insert\nan issue into our issue log, and commit the unit of work, without having a dependency on\nany actual implementation details. We could completely delete SqlAlchemy from our code\nbase, and our unit tests would continue to work, because we have a pure domain model and\nwe expose abstract ports from our service layer.`),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-python\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"When_reporting_an_issue\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"given_an_empty_unit_of_work\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        self`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" FakeUnitOfWork\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"because_we_report_a_new_issue\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        handler `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" ReportIssueHandler\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n        cmd `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" ReportIssueCommand\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"name\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" email\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" desc\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n        handler`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"handle\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cmd\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"the_handler_should_have_created_a_new_issue\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        expect`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"issues\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"to\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"have_len\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"it_should_have_recorded_the_issue\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        expect`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"issues\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"name\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"to\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"equal\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"name\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n        expect`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"issues\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"reporter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"email\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"to\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"equal\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"email\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"it_should_have_recorded_the_description\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        expect`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"issues\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"description\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"to\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"equal\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"desc\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"it_should_have_committed_the_unit_of_work\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\":\"),`\n        expect`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"self\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"uow\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"was_committed\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"to\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"be_true\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,mdx(\"a\",a({parentName:\"p\"},{href:\"http://io.made.com/blog/2017-09-13-commands-and-queries-handlers-and-views.html\"}),\"Next time\"),`\nwe'll look at how to get data back out of the system.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"date":"2017-09-08","title":"Repositoriy and unit of work pattern in python","layout":"post","author":"Bob","categories":["ports & adapters"],"tags":["python","architecture"]},"__N_SSG":true}