<!DOCTYPE html><html><head><link rel="icon" href="https://media.made.com/mws-assets/images/favicon.1.ico"/><link media="screen,handheld" type="text/css" rel="stylesheet" href="https://media.made.com/mws-assets/fontBase_b900f8d534cc10f95604.css"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Monitoring with Riemann and rsyslog part 3</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-f8fe1f0eb2299c5d.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-208998328ec77b24.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6cbe5accd1ec8e19.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-85c1567484db8bdb.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_buildManifest.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_ssgManifest.js" defer=""></script><script src="/_next/static/0V3tao8Q6Wc274G2cJ8zt/_middlewareManifest.js" defer=""></script></head><body><script>(function setScript(initialValue) {
  var mql = window.matchMedia("(prefers-color-scheme: dark)");
  var systemPreference = mql.matches ? "dark" : "light";
  var persistedPreference;

  try {
    persistedPreference = localStorage.getItem("chakra-ui-color-mode");
  } catch (error) {
    console.log("Chakra UI: localStorage is not available. Color mode persistence might not work as expected");
  }

  var isInStorage = typeof persistedPreference === "string";
  var colorMode;

  if (isInStorage) {
    colorMode = persistedPreference;
  } else {
    colorMode = initialValue === "system" ? systemPreference : initialValue;
  }

  if (colorMode) {
    var root = document.documentElement;
    root.style.setProperty("--chakra-ui-color-mode", colorMode);
  }
})('light')</script><div id="__next"><style data-emotion="css-global 1vs9c57">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-5:#fff2f0;--chakra-colors-red-10:#ffdfdd;--chakra-colors-red-50:#F15856;--chakra-colors-red-80:#d03740;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-5:#e4fbe5;--chakra-colors-green-10:#ccf5ce;--chakra-colors-green-50:#30a75b;--chakra-colors-green-80:#008248;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-made-5:#fafafa;--chakra-colors-made-10:#f5f6f4;--chakra-colors-made-20:#eef0ed;--chakra-colors-made-30:#e1e3de;--chakra-colors-made-40:#bdbfbb;--chakra-colors-made-50:#9fa19d;--chakra-colors-made-60:#767874;--chakra-colors-made-70:#626360;--chakra-colors-made-80:#434442;--chakra-colors-made-90:#222321;--chakra-colors-made-black:#131413;--chakra-colors-made-baige:#d9c3b8;--chakra-colors-made-green:#c0d0cf;--chakra-colors-made-grey:#d7d3d0;--chakra-colors-made-blue:#353F7D;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:FS Neruda;--chakra-fonts-body:FS Meridian Regular,sans-serif;--chakra-fonts-mono:FS Hack;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1syi0wy">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 1baqkrf">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-gray-800);background:var(--chakra-colors-white);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}</style><style data-emotion="css mfxtb">.css-mfxtb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;box-shadow:var(--chakra-shadows-base);width:100%;margin-bottom:var(--chakra-space-8);padding:var(--chakra-space-8);}</style><header class="css-mfxtb"><style data-emotion="css 18ci58h">.css-18ci58h{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;max-width:var(--chakra-sizes-8xl);width:100%;margin:auto;}</style><div class="css-18ci58h"><div class="css-0"><a href="/"><img alt="Logo" src="https://media.made.com/mws-assets/images/MadeLogo.2.svg" class="chakra-image css-0" aria-label="Logo"/></a></div><style data-emotion="css 1wsmmqi">@media screen and (min-width: 30em){.css-1wsmmqi{display:block;}}@media screen and (min-width: 48em){.css-1wsmmqi{display:none;}}</style><div class="css-1wsmmqi"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div><style data-emotion="css 3txhs">.css-3txhs{display:none;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;margin-left:auto;}@media screen and (min-width: 48em){.css-3txhs{display:block;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;}}</style><div class="css-3txhs"><style data-emotion="css 1lpw2d">.css-1lpw2d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:var(--chakra-space-8);-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}@media screen and (min-width: 30em){.css-1lpw2d{-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:var(--chakra-space-4);}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 48em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}@media screen and (min-width: 62em){.css-1lpw2d{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding-top:0px;}.css-1lpw2d>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:var(--chakra-space-8);margin-inline-start:var(--chakra-space-8);}}</style><div class="chakra-stack css-1lpw2d"><style data-emotion="css f4h6uy">.css-f4h6uy{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;}.css-f4h6uy:hover,.css-f4h6uy[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-f4h6uy:focus,.css-f4h6uy[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-f4h6uy" href="/"><style data-emotion="css 13o7eu2">.css-13o7eu2{display:block;}</style><p class="chakra-text css-13o7eu2">Home</p></a><a class="chakra-link css-f4h6uy" href="https://www.made.com/careers"><p class="chakra-text css-13o7eu2">Careers</p></a></div></div></div></header><style data-emotion="css 1gg6tci">.css-1gg6tci{width:100%;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;max-width:var(--chakra-sizes-2xl);-webkit-padding-start:1rem;padding-inline-start:1rem;-webkit-padding-end:1rem;padding-inline-end:1rem;}</style><div class="chakra-container css-1gg6tci"><style data-emotion="css 1xr7jem">.css-1xr7jem{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-5xl);line-height:1;margin-bottom:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-1xr7jem{font-size:var(--chakra-fontSizes-6xl);}}</style><h1 class="chakra-heading css-1xr7jem">Monitoring with Riemann and rsyslog part 3</h1><style data-emotion="css 1iv087f">.css-1iv087f{margin-bottom:var(--chakra-space-2);font-weight:var(--chakra-fontWeights-bold);}</style><p class="chakra-text css-1iv087f">by <!-- -->Bob</p><style data-emotion="css b64cj9">.css-b64cj9{margin-bottom:var(--chakra-space-4);color:var(--chakra-colors-made-50);}</style><p class="chakra-text css-b64cj9">Sun Jun 18 2017</p><style data-emotion="css rszk63">.css-rszk63{margin-bottom:var(--chakra-space-4);}</style><p class="chakra-text css-rszk63">Back in December I said I was interested in replacing Logstash with Rsyslog
<!-- -->[https://io.made.com/blog/rek-it/]<!-- -->, but that we needed a Riemann module to cover some of
our existing functionality. Specifically we send metrics to Riemann from Logstash for
three reasons:</p><ol><li>We send internal metrics from Logstash to monitor how events flow through our log
pipeline.</li><li>We forward all ERROR and CRITICAL logs to Riemann, which performs roll-up and
throttling. Errors are forwarded to Slack, and Criticals are sent to Pagerduty.</li><li>We allow developers to send application metrics in their structured log.</li></ol><p class="chakra-text css-rszk63">After some leisurely hacking over the last few days, I&#x27;ve got a Riemann module that
should cover all of our needs. We should be able to replace the internal metrics with
impstats <!-- -->[https://io.made.com/blog/monitoring-with-riemann-and-rsyslog-part-1/]<!-- --> as
discussed in part one of this series, so we won&#x27;t touch on that here.</p><p class="chakra-text css-rszk63">As before I&#x27;ve created a docker-compose playground on GitHub. This time the code is
under the /custom-metrics directory.</p><p class="chakra-text css-rszk63">Let&#x27;s see how ERRORs and CRITICALs can be sent to Riemann.</p><p class="chakra-text css-rszk63">We strongly encourage our developers to use structured logging in their applications;
rather than simply logging text, we log JSON objects. This allows us to add more context
into our logs, which makes it simpler to aggregate and search in Kibana.</p><p class="chakra-text css-rszk63">A typical structured log might look like this:</p><p class="chakra-text css-rszk63">{ &quot;@timestamp&quot;: &quot;2017-06-02T13:17:29.594Z&quot;, &quot;@version&quot;: &quot;1&quot;, &quot;@message&quot;: &quot;Incoming
request: GET /groups/GB/cat-16631&quot;, &quot;@fields&quot;: { &quot;request_path&quot;: &quot;/groups/GB/cat-16631&quot;,
&quot;request_method&quot;: &quot;GET&quot;, &quot;requestid&quot;: &quot;da11e322-fbba-4f7a-a638-621da3888017&quot;,</p><pre><style data-emotion="css 77j1of">.css-77j1of{background:var(--chakra-colors-orange-50);border-radius:10px;margin-bottom:var(--chakra-space-10);font-size:var(--chakra-fontSizes-sm);box-shadow:var(--chakra-shadows-lg);}</style><div class="chakra-wrap css-77j1of"><style data-emotion="css umyqv7">.css-umyqv7{--chakra-wrap-spacing:0.5rem;--wrap-spacing:calc(var(--chakra-wrap-spacing) / 2);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;list-style-type:none;padding:0px;margin:calc(var(--wrap-spacing) * -1);}.css-umyqv7>*:not(style){margin:var(--wrap-spacing);}</style><ul class="chakra-wrap__list css-umyqv7"><style data-emotion="css r4358i">.css-r4358i{padding:var(--chakra-space-5);}</style><div class="css-r4358i">  &quot;levelno&quot;: 20,
  &quot;levelname&quot;: &quot;INFO&quot;,

  &quot;pathname&quot;: &quot;./app.py&quot;,
  &quot;filename&quot;: &quot;app.py&quot;,
  &quot;lineno&quot;: 119,

  &quot;group_id&quot;: &quot;cat-16631&quot;,
  &quot;name&quot;: &quot;availability-api&quot;,
  &quot;country&quot;: &quot;GB&quot;
}
</div></ul></div></pre><p class="chakra-text css-rszk63">}</p><p class="chakra-text css-rszk63">As well as the obvious timestamp and textual message fields, we also include some
information about the request we&#x27;re handling, including a correlation id, some debugging
information so we can work out where the log was written, and some data from the
application.</p><p class="chakra-text css-rszk63">We also get logs from the Systemd Journal, and from third party and legacy applications,
so firstly we want to normalise the logs into a common format. As before, we&#x27;re going to
use mmnormalize for this task. Our mmnormalize rulebase
<!-- -->[https://github.com/bobthemighty/rek-stack-demos/blob/master/rek/custom-json-metrics/rsyslog/rsyslog-http.rb]<!-- -->
handles 3 kinds of logs: http access logs from nginx, structured json logs from our
Python API, and log4j style logs from our processing app.</p><p class="chakra-text css-rszk63">Firstly, we use mmnormalize to parse these different log formats into a json structure,
with a tag so we know what kind of data we have. We&#x27;re going to set a severity field on
the json according to some simple rules.</p><p class="chakra-text css-rszk63">For http logs, we&#x27;ll use INFO as our severity level if we have a status code &lt; 400,
otherwise ERROR. For plain text and json logs, we&#x27;ll convert the log4j log-level name
into a syslog-severity
<!-- -->[http://www.kiwisyslog.com/help/syslog/index.html?protocol_levels.htm]<!-- -->.</p><ul><li>INFO -&gt; info (6)</li><li>WARN -&gt; warn (4)</li><li>ERROR -&gt; error (3)</li><li>CRITICAL -&gt; critical (2)</li><li>FATAL -&gt; emergency (0)</li></ul><p class="chakra-text css-rszk63">(action type=&quot;mmnormalize&quot; rulebase=&quot;/etc/rsyslog/rules.rb&quot;)</p><style data-emotion="css 1i61012">.css-1i61012{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-6xl);line-height:1;}@media screen and (min-width: 48em){.css-1i61012{font-size:var(--chakra-fontSizes-7xl);}}</style><h1 class="chakra-heading css-1i61012">If this is an http log, use the status code</h1><p class="chakra-text css-rszk63">if
($!event.tags contains &quot;http&quot; and $!status &gt;= 400) then { set $!severity = 3; set
$!body!@fields!levelname
= &quot;error&quot;;</p><h1 class="chakra-heading css-1i61012"></h1><h1 class="chakra-heading css-1i61012">If we have a json log with a level name, map it back to a severity</h1><p class="chakra-text css-rszk63">} else if ($!body!@fields!levelname != &quot;&quot;) then { set $!severity =
cnum(lookup(&quot;log4j_level_to_severity&quot;, $!body!@fields!levelname)); }</p><p class="chakra-text css-rszk63">Now that we&#x27;ve got a normalised log level, we can use it to forward errors to Riemann:</p><p class="chakra-text css-rszk63">if ($syslogseverity &lt;= 3) then {</p><p class="chakra-text css-rszk63">(action type=&quot;omriemann&quot; server=&quot;riemann&quot; prefix=&quot;errors&quot; description=&quot;!msg&quot;) }</p><p class="chakra-text css-rszk63">By default omriemann uses the $programname as the &quot;service&quot; key in the Riemann message.
The prefix configuration setting prepends a fixed value to the service. When we send
errors through this configuration, we should see new metrics arriving in Riemann that
look like this:</p><p class="chakra-text css-rszk63">{:service &quot;errors/my-application&quot; :metric 1 :description &quot;a terrible thing occurred&quot; }</p><p class="chakra-text css-rszk63">With a sprinkling of Riemann magic, we can set up Slack and Email notifications with an
hourly summary of errors across our applications.</p><p class="chakra-text css-rszk63">Several of our applications are sending metrics to Riemann via the logging pipeline.
We&#x27;re moving away from this technique because it creates a dependency between our ELK
stack and our metrics: when Logstash stops stashing, we lose monitoring as well as logs.
Despite the flaws of this practice, it&#x27;s simple to explain to developers, and simple for
QA to verify, since it works by writing json to stdout.</p><p class="chakra-text css-rszk63">A typical metric log might look like this:</p><p class="chakra-text css-rszk63">{ &quot;@message&quot;: &quot;Request completed: 200 - 0.003793478012084961ms.&quot;, &quot;@timestamp&quot;:
&quot;2017-06-02T06:24:46.517Z&quot;, &quot;@fields&quot;: { &quot;requestid&quot;:
&quot;bfc153b2-a014-4a52-9090-46a1e3bf80da&quot;, &quot;levelname&quot;: &quot;INFO&quot;,</p><pre><div class="chakra-wrap css-77j1of"><ul class="chakra-wrap__list css-umyqv7"><div class="css-r4358i">  &quot;_riemann_metric&quot;: {
    &quot;metric&quot;: 0.003793478012084961,
    &quot;ttl&quot;: 60,
    &quot;service&quot;: &quot;availability.api.single_product.response_time&quot;,
    &quot;state&quot;: &quot;ok&quot;,
    &quot;attributes&quot;: {
      &quot;status_code&quot;: 200
    }
  }

},
&quot;@version&quot;: &quot;1&quot;,
</div></ul></div></pre><p class="chakra-text css-rszk63">}</p><p class="chakra-text css-rszk63">Here we have the same basic structure as our previous structured log, but with the
inclusion of a new field <!-- -->_<!-- -->riemann_metric. This metric represents the response time for
a single invocation of an API end point, and it includes the status code. We want to
pass this structure to Riemann.</p><p class="chakra-text css-rszk63">if($!<!-- -->_<!-- -->riemann_metric != &quot;&quot;) then {</p><p class="chakra-text css-rszk63">action(type=&quot;omriemann&quot; server=&quot;riemann&quot; subtree=&quot;!body!@fields!<!-- -->_<!-- -->riemann_metric&quot;
mode=&quot;single&quot;) }</p><p class="chakra-text css-rszk63">As in previous articles, we&#x27;re calling omriemann with a subtree that contains our metric
data. This time, however, we&#x27;re using mode=single. This tells omriemann that every
message contains a single metric, and that the fields of the json subtree should be
mapped to the fields of the Riemann message. This is different to our previous examples,
where we expect that each field of the subtree is a different metric.</p><p class="chakra-text css-rszk63">As before, I&#x27;ve included a dummy web application that returns a hard-coded status code
at each endpoint. This time, you can include a sleep time in milliseconds: curl
localhost/404?sleep=100.</p><p class="chakra-text css-rszk63">This will result in a metric log being sent to Rsyslog and through to Riemann so that we
can alert and report on it.</p><p class="chakra-text css-rszk63">Now that I can reproduce our Logstash/Riemann integration with Rsyslog, I can begin the
process of building a new REK stack.</p></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var c=Object.defineProperty,h=Object.defineProperties;var d=Object.getOwnPropertyDescriptors;var a=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable;var l=(e,t,o)=\u003et in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,i=(e,t)=\u003e{for(var o in t||(t={}))r.call(t,o)\u0026\u0026l(e,o,t[o]);if(a)for(var o of a(t))n.call(t,o)\u0026\u0026l(e,o,t[o]);return e},p=(e,t)=\u003eh(e,d(t));var m=(e,t)=\u003e{var o={};for(var s in e)r.call(e,s)\u0026\u0026t.indexOf(s)\u003c0\u0026\u0026(o[s]=e[s]);if(e!=null\u0026\u0026a)for(var s of a(e))t.indexOf(s)\u003c0\u0026\u0026n.call(e,s)\u0026\u0026(o[s]=e[s]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var s=o,{components:e}=s,t=m(s,[\"components\"]);return mdx(MDXLayout,p(i(i({},layoutProps),t),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,`Back in December I said I was interested in replacing Logstash with Rsyslog\n`,\"[https://io.made.com/blog/rek-it/]\",`, but that we needed a Riemann module to cover some of\nour existing functionality. Specifically we send metrics to Riemann from Logstash for\nthree reasons:`),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},`We send internal metrics from Logstash to monitor how events flow through our log\npipeline.`),mdx(\"li\",{parentName:\"ol\"},`We forward all ERROR and CRITICAL logs to Riemann, which performs roll-up and\nthrottling. Errors are forwarded to Slack, and Criticals are sent to Pagerduty.`),mdx(\"li\",{parentName:\"ol\"},\"We allow developers to send application metrics in their structured log.\")),mdx(\"p\",null,`After some leisurely hacking over the last few days, I've got a Riemann module that\nshould cover all of our needs. We should be able to replace the internal metrics with\nimpstats `,\"[https://io.made.com/blog/monitoring-with-riemann-and-rsyslog-part-1/]\",` as\ndiscussed in part one of this series, so we won't touch on that here.`),mdx(\"p\",null,`As before I've created a docker-compose playground on GitHub. This time the code is\nunder the /custom-metrics directory.`),mdx(\"p\",null,\"Let's see how ERRORs and CRITICALs can be sent to Riemann.\"),mdx(\"p\",null,`We strongly encourage our developers to use structured logging in their applications;\nrather than simply logging text, we log JSON objects. This allows us to add more context\ninto our logs, which makes it simpler to aggregate and search in Kibana.`),mdx(\"p\",null,\"A typical structured log might look like this:\"),mdx(\"p\",null,`{ \"@timestamp\": \"2017-06-02T13:17:29.594Z\", \"@version\": \"1\", \"@message\": \"Incoming\nrequest: GET /groups/GB/cat-16631\", \"@fields\": { \"request_path\": \"/groups/GB/cat-16631\",\n\"request_method\": \"GET\", \"requestid\": \"da11e322-fbba-4f7a-a638-621da3888017\",`),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),`  \"levelno\": 20,\n  \"levelname\": \"INFO\",\n\n  \"pathname\": \"./app.py\",\n  \"filename\": \"app.py\",\n  \"lineno\": 119,\n\n  \"group_id\": \"cat-16631\",\n  \"name\": \"availability-api\",\n  \"country\": \"GB\"\n}\n`)),mdx(\"p\",null,\"}\"),mdx(\"p\",null,`As well as the obvious timestamp and textual message fields, we also include some\ninformation about the request we're handling, including a correlation id, some debugging\ninformation so we can work out where the log was written, and some data from the\napplication.`),mdx(\"p\",null,`We also get logs from the Systemd Journal, and from third party and legacy applications,\nso firstly we want to normalise the logs into a common format. As before, we're going to\nuse mmnormalize for this task. Our mmnormalize rulebase\n`,\"[https://github.com/bobthemighty/rek-stack-demos/blob/master/rek/custom-json-metrics/rsyslog/rsyslog-http.rb]\",`\nhandles 3 kinds of logs: http access logs from nginx, structured json logs from our\nPython API, and log4j style logs from our processing app.`),mdx(\"p\",null,`Firstly, we use mmnormalize to parse these different log formats into a json structure,\nwith a tag so we know what kind of data we have. We're going to set a severity field on\nthe json according to some simple rules.`),mdx(\"p\",null,`For http logs, we'll use INFO as our severity level if we have a status code \u003c 400,\notherwise ERROR. For plain text and json logs, we'll convert the log4j log-level name\ninto a syslog-severity\n`,\"[http://www.kiwisyslog.com/help/syslog/index.html?protocol_levels.htm]\",\".\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"INFO -\u003e info (6)\"),mdx(\"li\",{parentName:\"ul\"},\"WARN -\u003e warn (4)\"),mdx(\"li\",{parentName:\"ul\"},\"ERROR -\u003e error (3)\"),mdx(\"li\",{parentName:\"ul\"},\"CRITICAL -\u003e critical (2)\"),mdx(\"li\",{parentName:\"ul\"},\"FATAL -\u003e emergency (0)\")),mdx(\"p\",null,'(action type=\"mmnormalize\" rulebase=\"/etc/rsyslog/rules.rb\")'),mdx(\"h1\",null,\"If this is an http log, use the status code\"),mdx(\"p\",null,`if\n($!event.tags contains \"http\" and $!status \u003e= 400) then { set $!severity = 3; set\n$!body!@fields!levelname\n= \"error\";`),mdx(\"h1\",null),mdx(\"h1\",null,\"If we have a json log with a level name, map it back to a severity\"),mdx(\"p\",null,`} else if ($!body!@fields!levelname != \"\") then { set $!severity =\ncnum(lookup(\"log4j_level_to_severity\", $!body!@fields!levelname)); }`),mdx(\"p\",null,\"Now that we've got a normalised log level, we can use it to forward errors to Riemann:\"),mdx(\"p\",null,\"if ($syslogseverity \u003c= 3) then {\"),mdx(\"p\",null,'(action type=\"omriemann\" server=\"riemann\" prefix=\"errors\" description=\"!msg\") }'),mdx(\"p\",null,`By default omriemann uses the $programname as the \"service\" key in the Riemann message.\nThe prefix configuration setting prepends a fixed value to the service. When we send\nerrors through this configuration, we should see new metrics arriving in Riemann that\nlook like this:`),mdx(\"p\",null,'{:service \"errors/my-application\" :metric 1 :description \"a terrible thing occurred\" }'),mdx(\"p\",null,`With a sprinkling of Riemann magic, we can set up Slack and Email notifications with an\nhourly summary of errors across our applications.`),mdx(\"p\",null,`Several of our applications are sending metrics to Riemann via the logging pipeline.\nWe're moving away from this technique because it creates a dependency between our ELK\nstack and our metrics: when Logstash stops stashing, we lose monitoring as well as logs.\nDespite the flaws of this practice, it's simple to explain to developers, and simple for\nQA to verify, since it works by writing json to stdout.`),mdx(\"p\",null,\"A typical metric log might look like this:\"),mdx(\"p\",null,`{ \"@message\": \"Request completed: 200 - 0.003793478012084961ms.\", \"@timestamp\":\n\"2017-06-02T06:24:46.517Z\", \"@fields\": { \"requestid\":\n\"bfc153b2-a014-4a52-9090-46a1e3bf80da\", \"levelname\": \"INFO\",`),mdx(\"pre\",null,mdx(\"code\",i({parentName:\"pre\"},{}),`  \"_riemann_metric\": {\n    \"metric\": 0.003793478012084961,\n    \"ttl\": 60,\n    \"service\": \"availability.api.single_product.response_time\",\n    \"state\": \"ok\",\n    \"attributes\": {\n      \"status_code\": 200\n    }\n  }\n\n},\n\"@version\": \"1\",\n`)),mdx(\"p\",null,\"}\"),mdx(\"p\",null,`Here we have the same basic structure as our previous structured log, but with the\ninclusion of a new field `,\"_\",`riemann_metric. This metric represents the response time for\na single invocation of an API end point, and it includes the status code. We want to\npass this structure to Riemann.`),mdx(\"p\",null,\"if($!\",\"_\",'riemann_metric != \"\") then {'),mdx(\"p\",null,'action(type=\"omriemann\" server=\"riemann\" subtree=\"!body!@fields!',\"_\",`riemann_metric\"\nmode=\"single\") }`),mdx(\"p\",null,`As in previous articles, we're calling omriemann with a subtree that contains our metric\ndata. This time, however, we're using mode=single. This tells omriemann that every\nmessage contains a single metric, and that the fields of the json subtree should be\nmapped to the fields of the Riemann message. This is different to our previous examples,\nwhere we expect that each field of the subtree is a different metric.`),mdx(\"p\",null,`As before, I've included a dummy web application that returns a hard-coded status code\nat each endpoint. This time, you can include a sleep time in milliseconds: curl\nlocalhost/404?sleep=100.`),mdx(\"p\",null,`This will result in a metric log being sent to Rsyslog and through to Riemann so that we\ncan alert and report on it.`),mdx(\"p\",null,`Now that I can reproduce our Logstash/Riemann integration with Rsyslog, I can begin the\nprocess of building a new REK stack.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"date":"2017-06-18","title":"Monitoring with Riemann and rsyslog part 3","layout":"post","author":"Bob","tags":["riemann","monitoring","elk"]},"__N_SSG":true},"page":"/[slug]","query":{"slug":"2017-06-18-monitoring-with-riemann-and-rsyslog-part-3"},"buildId":"0V3tao8Q6Wc274G2cJ8zt","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>